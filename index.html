<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5.0, user-scalable=yes" />
    <title>sisi</title>
    <link rel="apple-touch-icon" href="https://img3.autoimg.cn/g33/M04/BB/6C/ChxpVWlVaV6AdegHAALyV1UsDVk85.jpeg">
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Montserrat:wght@300;400;500&display=swap"
        rel="stylesheet">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f0f2f5">
  <script type="module" crossorigin src="./assets/index-imDjhqIS.js"></script>
  <link rel="stylesheet" crossorigin href="./assets/index-BJ0IZlZM.css">
</head>

<body>

    <div id="phone-screen">
        <div id="home-screen">
            <div id="vue-root"></div>
        </div>
        <div id="app-settings" class="app-window" style="background: #F9F9FC;">
            <div class="app-header">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeApp('settings')">
                        <svg viewBox="0 0 24 24" width="28" height="28">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>

                    </div>
                    <div class="header-title"><span style="font-size:17px;font-weight:600;">设置</span></div>
                    <div class="header-right" style="width:40px;"></div>
                </div>
            </div>

            <div class="app-body">
                <div class="setting-group">
                    <div class="setting-row" onclick="openSubPage('api')">
                        <span class="setting-row-title">API 设置</span>
                        <svg class="setting-row-arrow" viewBox="0 0 24 24">
                            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                        </svg>
                    </div>
                    <div class="setting-row" onclick="openSubPage('automation')">
                        <span class="setting-row-title">自动化与后台</span>
                        <svg class="setting-row-arrow" viewBox="0 0 24 24">
                            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                        </svg>
                    </div>
                    <div class="setting-row">
                        <span class="setting-row-title">通用</span>
                        <svg class="setting-row-arrow" viewBox="0 0 24 24">
                            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                        </svg>
                    </div>
                </div>
                <div style="padding:20px; text-align:center; color:#ccc; font-size:12px;">
                    Version 1.0.0
                </div>
            </div>

            <div id="sub-page-api" class="sub-page">
                <div class="app-header">
                    <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                    <div class="header-content">
                        <div class="header-left" onclick="closeSubPage('api')" style="width: 40px; padding-left: 5px;">
                            <svg viewBox="0 0 24 24" width="28" height="28">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                            </svg>
                        </div>
                        <div class="header-title"><span style="font-size:17px;font-weight:600;">API 配置</span></div>
                        <div class="header-right" style="width:40px;"></div>
                    </div>
                </div>

                <div class="app-body" style="padding: 20px 16px;">
                    <div style="margin-bottom: 20px;">
                        <div style="font-size:12px; color:#999; margin-bottom:8px; margin-left:4px;">配置预设 (长按删除)</div>
                        <div id="api-preset-container" class="group-tabs-container">
                            <!-- 动态生成 -->
                        </div>
                    </div>
                    <label class="setting-label">API 厂商</label>
                    <div class="input-wrapper">
                        <select id="api-provider" class="setting-input" style="background-image:none;"
                            onchange="toggleApiProvider(this.value)">
                            <option value="openai">OpenAI (GPT)</option>
                            <option value="google">Google (Gemini)</option>
                        </select>
                    </div>
                    <label class="setting-label">API Base URL (选填)</label>
                    <div class="input-wrapper">
                        <input type="text" id="api-host" class="setting-input" placeholder="https://api.openai.com/v1">
                    </div>

                    <label class="setting-label">API Key (多Key请用英文逗号分隔)</label>
                    <div class="input-wrapper">
                        <input type="password" id="api-key" class="setting-input"
                            placeholder="sk-aaa, sk-bbb, sk-ccc...">
                    </div>

                    <label class="setting-label">模型选择</label>
                    <div class="model-selector-box">
                        <input type="text" id="api-model-input" class="model-input"
                            placeholder="手动输入模型ID (如 gpt-4) 或拉取列表" onclick="event.stopPropagation()">
                        <div class="fetch-btn" onclick="fetchModels(event)">
                            <svg id="fetch-icon" viewBox="0 0 24 24" width="20" height="20" fill="#9B9ECE">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg>
                        </div>
                    </div>

                    <div id="model-list-container" class="model-dropdown"></div>
                    <label class="setting-label" style="margin-top: 20px;">
                        温度 (创造性): <span id="temp-display" style="color:#9B9ECE; font-weight:bold;">0.7</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="range" id="api-temp" style="width:100%;" min="0" max="2" step="0.1" value="0.7"
                            oninput="document.getElementById('temp-display').innerText = this.value">
                    </div>
                    <div class="premium-setting-card" style="margin-top: 25px;">
                        <!-- 左侧：图标+文字 -->
                        <div class="premium-card-left">
                            <div class="premium-icon-box">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                                    <path
                                        d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                                </svg>
                            </div>
                            <div class="premium-text-group">
                                <div class="premium-title">朋友圈识图</div>
                                <div class="premium-desc">Vision 模型预设</div>
                            </div>
                        </div>

                        <!-- 右侧：隐形下拉框+箭头 -->
                        <div class="premium-card-right">
                            <select id="moment-rec-preset" class="premium-select">
                                <option value="">跟随主配置</option>
                                <!-- JS 会填充选项 -->
                            </select>
                            <svg class="premium-arrow" viewBox="0 0 24 24" width="18" height="18" fill="#ccc">
                                <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                            </svg>
                        </div>
                    </div>
                    <div class="premium-setting-card" style="margin-top: 10px;">
                        <!-- 左侧：图标+文字 -->
                        <div class="premium-card-left">
                            <div class="premium-icon-box"
                                style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                                <!-- 稍微换个颜色区分 -->
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                                    <path
                                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" />
                                </svg>
                            </div>
                            <div class="premium-text-group">
                                <div class="premium-title">记忆总结</div>
                                <div class="premium-desc">Memory 模型预设</div>
                            </div>
                        </div>

                        <!-- 右侧：隐形下拉框+箭头 -->
                        <div class="premium-card-right">
                            <select id="memory-api-preset" class="premium-select">
                                <option value="">跟随主配置</option>
                                <!-- JS 会填充选项 -->
                            </select>
                            <svg class="premium-arrow" viewBox="0 0 24 24" width="18" height="18" fill="#ccc">
                                <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                            </svg>
                        </div>
                    </div>
                    <!-- 底部提示文字 -->
                    <div style="text-align: center; margin: 12px 0 30px 0;">
                        <span style="font-size: 11px; color: #b0b0b0; letter-spacing: 0.5px; opacity: 0.8;">
                            推荐使用支持 Vision 能力的模型以获得最佳体验
                        </span>
                    </div>

                    <!-- 2. 保存按钮 (弥散光影风格) -->
                    <div style="margin-bottom: 40px;">
                        <button class="btn-premium-gradient" onclick="manualSaveApi()">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                                style="margin-right:6px;">
                                <path
                                    d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
                            </svg>
                            保存配置
                        </button>
                    </div>


                </div>
            </div>
            <div id="sub-page-automation" class="sub-page">
                <div class="app-header">
                    <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                    <div class="header-content">
                        <div class="header-left" onclick="closeSubPage('automation')"
                            style="width: 40px; padding-left: 5px;">
                            <svg viewBox="0 0 24 24" width="28" height="28">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                            </svg>
                        </div>
                        <div class="header-title"><span style="font-size:17px;font-weight:600;">自动化与后台</span></div>
                        <div class="header-right" style="width:40px;"></div>
                    </div>
                </div>

                <div class="app-body" style="padding: 20px 16px;">
                    <label class="setting-label">朋友圈</label>
                    <div class="settings-card" style="margin:0 0 20px 0;">
                        <div class="settings-item">
                            <div class="settings-text">
                                <h4>后台发帖模式</h4>
                                <p>进入朋友圈时 AI 会尝试自主发帖</p>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="ai-action-switch" onchange="toggleAIActionMode(this)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 这里预留位置，以后可以加其他的后台设置 -->
                    <p style="font-size:12px; color:#999; margin-top:10px;">开启后，系统会在特定场景下模拟角色的自主行为。</p>
                </div>
            </div>
        </div>
        <div id="app-chat" class="app-window">
            <div class="app-header">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeApp('chat')">
                        <svg viewBox="0 0 24 24" width="28" height="28">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                    </div>
                    <div class="header-title"><span id="app-title-text">消息</span></div>

                    <div id="btn-add-contact" class="header-right" onclick="openContactPage()" style="display:none;">
                        <svg viewBox="0 0 24 24" width="26" height="26" fill="#9B9ECE">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="app-body">
                <div id="tab-msgs" class="tab-content active">
                    <div id="msg-list"></div>
                </div>

                <div id="tab-contacts" class="tab-content">
                    <div style="position:sticky; top:0; background:#F9F9FC; z-index:10; padding-bottom:10px;">

                        <!-- 横向滚动胶囊栏 -->
                        <div id="contact-filter-bar" class="group-tabs-container" style="padding: 12px 16px 4px 16px;">
                            <!-- 动态生成: [全部] [家人] [同学] (+) -->
                        </div>

                    </div>
                    <div class="menu-item" onclick="openGroupCreateUI()"
                        style="margin: 16px 16px 10px 16px; height: 70px; box-sizing: border-box;">
                        <div class="avatar"
                            style="width:40px; height:40px; background:#9B9ECE; display:flex; align-items:center; justify-content:center;">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg>
                        </div>
                        <div class="chat-info" style="flex-grow:1;">
                            <h4 style="margin:0;">发起群聊</h4>
                            <p style="margin:0; font-size:12px; color:#999;">创建一个新的多人会话</p>
                        </div>
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="#ccc">
                            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                        </svg>
                    </div>

                    <div id="contact-list-dynamic"></div>
                </div>

                <div id="tab-moment" class="tab-content">
                    <div class="menu-item" onclick="openApp('moments')" style="cursor:pointer;">
                        <div class="avatar" style="width:36px; height:36px; background:none; margin-right: 12px;">
                            <div
                                style="width:100%; height:100%; border-radius:6px; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                                    <path
                                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z" />
                                </svg>
                            </div>
                        </div>
                        <div class="chat-info" style="border-bottom:none;">
                            <h4>朋友圈</h4>
                        </div>
                        <div style="margin-left:auto;">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="#ccc">
                                <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                            </svg>
                        </div>
                    </div>
                    <div class="menu-item" onclick="openApp('regex-mgr')" style="cursor:pointer; margin-top:12px;">
                        <div class="avatar" style="width:36px; height:36px; background:none; margin-right: 12px;">
                            <!-- 莫兰迪紫渐变背景 + 代码图标 -->
                            <div
                                style="width:100%; height:100%; border-radius:10px; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, #9B9ECE 0%, #a2a6d5 100%); box-shadow: 0 4px 10px rgba(155,158,206,0.3);">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                                    <path
                                        d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z" />
                                </svg>
                            </div>
                        </div>
                        <div class="chat-info" style="border-bottom:none;">
                            <h4>正则工坊</h4>
                            <p style="font-size:12px;color:#999;">Snippet & Regex Library</p>
                        </div>
                        <div style="margin-left:auto;">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="#ccc">
                                <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div id="tab-me" class="tab-content">
                    <div id="me-content-placeholder"></div>
                </div>
            </div>

            <div class="app-tabbar">
                <div class="tab-item active" onclick="switchTab('msgs', this)">
                    <svg viewBox="0 0 24 24">
                        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
                    </svg>
                    <span>消息</span>
                </div>
                <div class="tab-item" onclick="switchTab('contacts', this)">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                    </svg><span>好友</span>
                </div>
                <div class="tab-item" onclick="switchTab('moment', this)">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M12 10.9c-.61 0-1.1.49-1.1 1.1s.49 1.1 1.1 1.1c.61 0 1.1-.49 1.1-1.1s-.49-1.1-1.1-1.1zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm2.19 12.19L6 18l3.81-8.19L18 6l-3.81 8.19z" />
                    </svg><span>发现</span>
                </div>
                <div class="tab-item" onclick="switchTab('me', this)">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg><span>我</span>
                </div>
            </div>
        </div>
        <div id="app-conversation" class="app-window" style="background: #F9F9FC;">
            <div class="app-header">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeApp('conversation')">
                        <svg viewBox="0 0 24 24" width="28" height="28">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                    </div>
                    <div class="header-title conversation-header">
                        <span id="chat-title-text">聊天</span>
                        <div class="status-container">
                            <span id="chat-status-dot" class="status-dot"></span>
                            <span id="chat-status-text">离线</span>
                        </div>
                    </div>
                    <div class="header-right" onclick="openChatSettings()"
                        style="width:40px; display:flex; justify-content:center;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="#9B9ECE">
                            <path
                                d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="app-body" id="chat-body" style="padding-bottom: 70px; background: #F9F9FC;">
            </div>

            <div class="chat-footer">
                <!-- 1. 引用预览条 (保持不变) -->
                <div id="reply-preview-bar">
                    <div class="reply-content-box">
                        <span id="reply-bar-name" class="reply-target-name">引用: 对方名字</span>
                        <span id="reply-bar-text" class="reply-target-text">消息内容...</span>
                    </div>
                    <div class="reply-close-btn" onclick="cancelQuote()">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path
                                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                        </svg>
                    </div>
                </div>

                <!-- 2. 左侧加号按钮 (保持不变，只是稍微调整右边距) -->
                <div class="icon-btn" onclick="toggleFeaturePanel()" style="margin-right: 4px;">
                    <svg viewBox="0 0 24 24" width="28" height="28" fill="#9B9ECE">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                    </svg>
                </div>

                <!-- 3. [核心修改] 组合输入框容器 (灰色胶囊) -->
                <div class="chat-input-wrapper">
                    <!-- 真正的输入框：背景透明，文字输入区域 -->
                    <textarea class="chat-input" rows="1" placeholder="输入消息..."></textarea>

                    <!-- 心声按钮：现在放到了胶囊内部右侧 -->
                    <div class="inner-thought-btn" onclick="showLatestInnerThought()">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="#9B9ECE">
                            <path
                                d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                        </svg>
                    </div>
                </div>

                <!-- 4. 表情按钮 (紧挨着输入框) -->
                <div class="icon-btn" onclick="toggleChatStickerPanel()" style="margin-left: 4px;">
                    <svg viewBox="0 0 24 24" width="28" height="28" fill="#9B9ECE">
                        <path
                            d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" />
                    </svg>
                </div>

                <!-- 5. 发送按钮 (紧挨着表情) -->
                <div class="icon-btn ai-send-btn" onclick="triggerAIResponse(this)" style="margin-left: 4px;">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                        <path
                            d="M21.435 2.582a1.933 1.933 0 00-1.93-.503L3.408 6.759a1.92 1.92 0 00-1.384 1.522c-.142.75.355 1.704 1.003 2.102l5.033 3.094 2.054 3.83c.21.39.426.779.803.957.25.119.531.149.789.043.435-.178.68-.621.844-1.049l.643-1.685 4.095 2.517c.504.31.956.276 1.342-.037.456-.37.648-.96.721-1.536l2.365-11.87a1.986 1.986 0 00-.281-1.666zM18.89 5.385l-8.55 7.684-1.748-1.075 10.298-6.609z" />
                    </svg>
                </div>
            </div>
            <div id="chat-multiselect-bar" class="wb-bottom-bar" style="z-index: 200;">
                <!-- 左侧：取消 (X 图标，使用主题紫) -->
                <div class="wb-bar-btn" onclick="exitMultiSelectMode()" style="flex:1;">
                    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="#9B9ECE" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </div>

                <!-- 右侧：删除 (垃圾桶图标，改用主题紫) -->
                <div class="wb-bar-btn" onclick="doBatchDeleteMsgs()" style="flex:1;">
                    <svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="#9B9ECE" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </div>
            </div>

            <div id="chat-feature-panel">
                <div class="feature-item" onclick="handleVoiceSend()">
                    <div class="feature-icon-box" style="background: #9B9ECE;">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="white">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.66 9 5v6c0 1.66 1.34 3 3 3z" />
                            <path
                                d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                        </svg>
                    </div>
                    <div class="feature-name">语音</div>
                </div>

                <div class="feature-item" onclick="handlePhotoPanel()">
                    <div class="feature-icon-box" style="background: #9B9ECE;">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="white">
                            <path
                                d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
                        </svg>
                    </div>
                    <div class="feature-name">照片</div>
                </div>

                <div class="feature-item" onclick="handleTransferPanel()">
                    <div class="feature-icon-box" style="background: #9B9ECE;"> <svg viewBox="0 0 24 24" width="22"
                            height="22" fill="white">
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm.5 14h-3v-1c-1.65 0-3-1.35-3-3s1.35-3 3-3h3v-1H9v-2h2V4h2v2h2c1.65 0 3 1.35 3 3s-1.35 3-3 3h-2.5v1h3v2h-2v2z" />
                        </svg>
                    </div>
                    <div class="feature-name">转账</div>
                </div>
                <div class="feature-item" onclick="openManualSummaryModal()">
                    <div class="feature-icon-box" style="background: #9B9ECE;">
                        <!-- 一个大脑/芯片的图标，代表记忆处理 -->
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="white">
                            <path
                                d="M15 9c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm4-7H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-6 15H7v-2h6v2zm4-4H7v-2h10v2zm0-4h-6V7h6v2z" />
                        </svg>
                    </div>
                    <div class="feature-name">记忆总结</div>
                </div>
            </div>
            <div id="chat-sticker-panel" style="display:none;">
                <div class="sticker-panel-header-bar"
                    style="display:flex; align-items:center; border-bottom:1px solid #eee; background:#fff; padding-right:10px;">
                    <div id="chat-sticker-tabs" class="category-scroll-container"
                        style="flex-grow:1; padding: 8px 10px; border-bottom:none; margin-bottom:0;"></div>

                    <div onclick="openStickerMountModal()"
                        style="padding: 6px; cursor:pointer; color:#999; display:flex;">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path
                                d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z">
                            </path>
                        </svg>
                    </div>
                </div>

                <div id="chat-sticker-body" style="flex:1; overflow-y:auto; padding:10px; position:relative;"></div>
            </div>
        </div>
        <div id="modal-sticker-mount" class="modal-overlay" style="z-index: 650;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-sticker-mount').style.display='none'">×
                </div>
                <h3 style="margin-top:0;">表情包管理</h3>
                <p style="font-size:12px;color:#999;margin-bottom:15px;">勾选要在这个聊天中显示的表情包</p>

                <div id="st-mount-list" style="max-height:300px; overflow-y:auto;"></div>

                <button class="btn-main" onclick="saveStickerMount()">保存设置</button>
            </div>
        </div>
        <div id="modal-select-me" class="modal-overlay">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-select-me').style.display='none'">×
                </div>
                <h3 style="margin-top:0;">我是谁？</h3>
                <p style="color:#999; font-size:12px; margin-bottom:15px;">请选择你要使用的身份面具</p>
                <div id="persona-select-list" style="max-height:250px; overflow-y:auto;"></div>
            </div>
        </div>

        <div id="app-persona-mgr" class="app-window" style="background: #F9F9FC;">
            <div class="app-header">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="handlePersonaBack()">
                        <svg viewBox="0 0 24 24" width="28" height="28">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                    </div>
                    <div class="header-title"><span id="persona-page-title"
                            style="font-size:17px;font-weight:600;">我的身份</span></div>
                    <div id="btn-add-persona" class="header-right" onclick="showPersonaForm()">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="#9B9ECE">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="app-body" style="padding: 20px 16px;">

                <div id="view-persona-list">
                    <p style="font-size:12px;color:#999;margin-bottom:15px;text-align:center;">点击卡片切换当前使用的身份</p>
                    <div id="persona-list-container">
                    </div>
                </div>

                <div id="view-persona-form" style="display:none;">
                    <div style="text-align:center; margin-bottom:25px;">
                        <div class="avatar-tabs">
                            <div class="avatar-tab active" id="tab-file" onclick="toggleAvatarMode('file')">本地上传</div>
                            <div class="avatar-tab" id="tab-url" onclick="toggleAvatarMode('url')">URL链接</div>
                        </div>

                        <div id="input-group-file" class="avatar-upload"
                            onclick="document.getElementById('file-input').click()"
                            style="width:80px;height:80px;background:#fff;border-radius:20px;margin:0 auto;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid #eee;box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                            <img id="preview-file" src="" style="width:100%;height:100%;object-fit:cover;display:none;">
                            <span id="ph-file"
                                style="font-size:12px;color:#999;display:flex;flex-direction:column;align-items:center;">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="#ccc" style="margin-bottom:4px;">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                                </svg>
                                上传
                            </span>
                        </div>
                        <input type="file" id="file-input" hidden accept="image/*" onchange="handleFile(this)">

                        <div id="input-group-url" style="display:none; margin-top:10px;">
                            <input type="text" id="url-input" class="setting-input" placeholder="粘贴图片链接..."
                                oninput="handleUrl(this)">
                            <div
                                style="width:80px;height:80px;background:#fff;border-radius:20px;margin:15px auto 0;overflow:hidden;border:1px solid #eee;">
                                <img id="preview-url" src=""
                                    style="width:100%;height:100%;object-fit:cover;display:none;">
                            </div>
                        </div>
                    </div>

                    <label class="setting-label">姓名</label>
                    <div class="input-wrapper">
                        <input type="text" id="inp-name" class="setting-input" placeholder="你的名字">
                    </div>

                    <label class="setting-label">人设描述</label>
                    <div class="input-wrapper">
                        <textarea id="inp-desc" class="setting-input"
                            style="height:120px; padding-top:12px; line-height:1.5;"
                            placeholder="写点什么人设描述吧..."></textarea>
                    </div>



                    <div style="height:40px;"></div>
                    <button class="btn-main" onclick="savePersona()"
                        style="box-shadow: 0 5px 15px rgba(155, 158, 206, 0.4);">保存身份</button>
                    <div style="height:30px;"></div>
                </div>
            </div>
        </div>

        <div id="btn-add-contact" class="header-right" onclick="openContactPage()" style="display:none;">
            <svg viewBox="0 0 24 24" width="26" height="26" fill="#9B9ECE">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
            </svg>
        </div>

        <div id="app-contact-edit" class="app-window" style="background: #F9F9FC;">
            <div class="app-header">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeContactPage()">
                        <svg viewBox="0 0 24 24" width="28" height="28">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                    </div>
                    <div class="header-title"><span id="contact-page-title"
                            style="font-size:17px;font-weight:600;">添加好友</span></div>
                    <div class="header-right" style="width:40px;"></div>
                </div>
            </div>

            <div class="app-body" style="padding: 20px 16px;">

                <div style="text-align:center; margin-bottom:25px;">
                    <div class="avatar-tabs">
                        <div class="avatar-tab active" id="tab-c-file" onclick="toggleContactMode('file')">本地上传</div>
                        <div class="avatar-tab" id="tab-c-url" onclick="toggleContactMode('url')">URL链接</div>
                    </div>

                    <div id="c-input-group-file" class="avatar-upload"
                        onclick="document.getElementById('c-file-input').click()"
                        style="width:80px;height:80px;background:#fff;border-radius:20px;margin:0 auto;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid #eee;box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                        <img id="c-preview-file" src="" style="width:100%;height:100%;object-fit:cover;display:none;">
                        <span id="c-ph-file"
                            style="font-size:12px;color:#999;display:flex;flex-direction:column;align-items:center;">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="#ccc" style="margin-bottom:4px;">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg>
                            上传
                        </span>
                    </div>
                    <input type="file" id="c-file-input" hidden accept="image/*" onchange="handleContactFile(this)">

                    <div id="c-input-group-url" style="display:none; margin-top:10px;">
                        <input type="text" id="c-url-input" class="setting-input" placeholder="粘贴图片链接..."
                            oninput="handleContactUrl(this)">
                        <div
                            style="width:80px;height:80px;background:#fff;border-radius:20px;margin:15px auto 0;overflow:hidden;border:1px solid #eee;">
                            <img id="c-preview-url" src=""
                                style="width:100%;height:100%;object-fit:cover;display:none;">
                        </div>
                    </div>
                </div>

                <label class="setting-label">姓名 / 昵称</label>
                <div class="input-wrapper">
                    <input type="text" id="c-inp-name" class="setting-input" placeholder="给TA起个名字">
                </div>

                <label class="setting-label">人设描述 / 备注</label>
                <div class="input-wrapper">
                    <textarea id="c-inp-desc" class="setting-input"
                        style="height:120px; padding-top:12px; line-height:1.5;"
                        placeholder="输入详细的人设描述、性格特征或备注信息..."></textarea>
                </div>
                <label class="setting-label">所属分组</label>
                <div id="contact-edit-groups" class="group-tabs-container"
                    style="margin-bottom:20px; flex-wrap:wrap; overflow:visible;">
                    <!-- 动态渲染可选分组 -->
                </div>
                <label class="setting-label" style="margin-top:20px;">角色类型</label>
                <div class="settings-card" style="margin:0 0 20px 0; border:1px solid #eee; box-shadow:none;">
                    <div class="settings-item">
                        <div class="settings-text">
                            <h4>设为 NPC (背景人物)</h4>
                            <p>NPC 不会进入聊天列表，仅用于构建关系网或作为群聊背景板</p>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="c-npc-switch">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-card" style="margin:0 0 10px 0; border:1px solid #eee; box-shadow:none;">
                    <div class="settings-item">
                        <div class="settings-text">
                            <h4>允许后台发布朋友圈</h4>
                            <p>开启后，AI 将根据设定自主发帖或评论</p>
                        </div>
                        <label class="ios-switch">
                            <!-- 修改：添加 onchange 事件来控制下方选项的显示 -->
                            <input type="checkbox" id="c-auto-moment-switch" onchange="toggleFrequencySelector(this)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <!-- 新增：频率选择区域 (默认隐藏) -->
                <div id="c-freq-container" style="display:none; margin-bottom: 20px; animation: fadeIn 0.3s;">
                    <label class="setting-label">活跃频率</label>
                    <div class="input-wrapper">
                        <select id="c-freq-select" class="setting-input" style="background-image:none;">
                            <option value="low">低 (偶尔诈尸)</option>
                            <option value="medium" selected>中 (正常人类)</option>
                            <option value="high">高 (高强度冲浪)</option>
                        </select>
                    </div>
                    <p style="font-size:12px; color:#999; margin-top:-10px; margin-bottom: 10px;">
                        决定了心跳检测时该角色触发行动的概率。
                    </p>
                </div>
                <div class="schedule-entry-card" onclick="openScheduleMgr()">
                    <div style="display:flex; align-items:center;">
                        <!-- 左侧 SVG 图标 -->
                        <div class="schedule-icon-box">
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                <path
                                    d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" />
                            </svg>
                        </div>
                        <div class="settings-text">
                            <h4 style="margin:0 0 4px 0; font-size:16px; color:#333;">每日作息表</h4>
                            <p style="margin:0; font-size:12px; color:#999;">设定 NPC 的日常规律与事件</p>
                        </div>
                    </div>
                    <!-- 右侧 SVG 箭头 -->
                    <svg class="ios-arrow" viewBox="0 0 24 24" width="20" height="20" fill="#ccc">
                        <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                    </svg>
                </div>
                <div class="schedule-entry-card" onclick="openApp('memory')" style="margin-top: 10px;">
                    <div style="display:flex; align-items:center;">
                        <!-- 左侧图标 (淡紫色背景 + 大脑图标) -->
                        <div class="schedule-icon-box" style="background: #F4EAF4; color: #9E90A3;">
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" />
                            </svg>
                        </div>
                        <div class="settings-text">
                            <h4 style="margin:0 0 4px 0; font-size:16px; color:#333;">记忆档案</h4>
                            <p style="margin:0; font-size:12px; color:#999;">Memory & Metamorphosis</p>
                        </div>
                    </div>
                    <!-- 右侧箭头 -->
                    <svg class="ios-arrow" viewBox="0 0 24 24" width="20" height="20" fill="#ccc">
                        <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                    </svg>
                </div>
                <div style="height:40px;"></div> <button class="btn-main" onclick="saveContact()"
                    style="box-shadow: 0 5px 15px rgba(155, 158, 206, 0.4);">保存资料</button>
                <div style="height:30px;"></div>
            </div>
        </div>
        <div id="app-group-create" class="app-window" style="background: #F9F9FC;">
            <div class="app-header">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeApp('group-create')">
                        <span style="font-size:16px;color:#666;">取消</span>
                    </div>
                    <div class="header-title"><span style="font-size:17px;font-weight:600;">发起群聊</span></div>
                    <div class="header-right" onclick="submitCreateGroup()">
                        <span style="font-size:16px;color:var(--theme-purple);font-weight:600;">完成</span>
                    </div>
                </div>
            </div>

            <div class="app-body" style="padding: 20px 16px;">

                <label class="setting-label">群聊名称</label>
                <div class="input-wrapper">
                    <input type="text" id="group-name-input" class="setting-input" placeholder="例如：异世界冒险小队">
                </div>

                <label class="setting-label">选择你的身份 (我是谁)</label>
                <div id="group-me-list" class="select-list-container">
                </div>

                <label class="setting-label" style="margin-top:20px;">选择群成员 (邀请谁)</label>
                <div id="group-contact-list" class="select-list-container">
                </div>

                <div style="height:50px;"></div>
            </div>
        </div>

        <div id="app-chat-settings" class="app-window" style="background: #F2F2F7;">
            <div class="app-header" style="background: #fff;">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeApp('chat-settings')">
                        <svg viewBox="0 0 24 24" width="28" height="28">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                    </div>
                    <div class="header-title"><span style="font-size:17px;font-weight:600;">聊天设置</span></div>
                    <div class="header-right" style="width:40px;"></div>
                </div>
            </div>

            <div class="app-body">
                <div id="setting-identity-container" style="display:none;">
                    <div style="margin: 20px 0 8px 20px; font-size:13px; color:#888;">当前身份</div>
                    <div class="ios-group">
                        <div class="setting-row" onclick="openChatIdentitySwitcher()">
                            <div class="ios-text-box">
                                <div class="ios-title">我是谁</div>
                                <div id="setting-identity-name" class="ios-desc">User</div>
                            </div>
                            <div style="display:flex; align-items:center;">
                                <span style="font-size:14px; color:#9B9ECE; margin-right:5px;">切换</span>
                                <svg class="ios-arrow" viewBox="0 0 24 24">
                                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin: 20px 0 8px 20px; font-size:13px; color:#888;">外观</div>
                <div class="ios-group">
                    <div class="setting-row" onclick="openSubPage('visual')">
                        <div class="ios-text-box">
                            <div class="ios-title">头像与昵称</div>
                        </div>
                        <svg class="ios-arrow" viewBox="0 0 24 24">
                            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                        </svg>
                    </div>
                </div>

                <div style="margin: 0 0 8px 20px; font-size:13px; color:#888;">记忆与设定</div>
                <div class="ios-group">
                    <div class="setting-row">
                        <div class="ios-text-box">
                            <div class="ios-title">短期记忆</div>
                            <div class="ios-desc">携带的历史消息数量</div>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <input type="number" id="setting-context-limit" value="25" class="ios-value-input"
                                onchange="saveContextLimit(this.value)">
                            <span style="color:#8E8E93; font-size:15px; margin-left:4px;">条</span>
                        </div>
                    </div>
                    <div class="setting-row">
                        <div class="ios-text-box">
                            <div class="ios-title">长期记忆总结</div>
                            <div class="ios-desc">自动提炼情景、语义与反思记忆</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="lt-memory-switch" onchange="toggleLongTermMemory(this)">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <!-- === 新增：长期记忆详细配置面板 (默认隐藏) === -->
                    <div id="lt-memory-panel"
                        style="display:none; background:#fff; padding-left: 16px; margin-top:-1px;">

                        <!-- 内部的 row 保持不变，但要把 border-bottom 的颜色调淡一点或者去掉，避免太乱 -->
                        <div class="setting-row"
                            style="background:transparent; border-bottom:1px solid #f5f5f5; padding-left:0;">
                            <div class="ios-text-box">
                                <div class="ios-title" style="font-size:15px;">总结频率</div>
                                <div class="ios-desc">每隔多少条消息触发一次</div>
                            </div>
                            <div style="display:flex; align-items:center;">
                                <input type="number" id="lt-memory-interval" value="20" class="ios-value-input"
                                    style="width:40px;" onchange="saveLtMemoryConfig()">
                                <span style="color:#8E8E93; font-size:14px; margin-left:4px;">条</span>
                            </div>
                        </div>

                        <div class="setting-row"
                            style="background:transparent; border-bottom:1px solid #f5f5f5; padding-left:0;">
                            <div class="ios-text-box">
                                <div class="ios-title" style="font-size:15px;">记忆互通</div>
                                <div class="ios-desc">允许与其他会话共享记忆</div>
                            </div>
                            <label class="ios-switch" style="transform:scale(0.9);">
                                <input type="checkbox" id="lt-memory-share-switch" onchange="toggleMemorySharing(this)">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div id="lt-share-selector-row" class="setting-row" onclick="openMemoryShareSelector()"
                            style="background:transparent; border:none; padding-left:0; display:none;">
                            <div class="ios-text-box">
                                <div class="ios-title" style="font-size:15px; color:#9B9ECE;">选择互通会话</div>
                                <div id="lt-share-status" class="ios-desc">点击选择</div>
                            </div>
                            <svg class="ios-arrow" viewBox="0 0 24 24">
                                <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                            </svg>
                        </div>
                    </div>
                    <div class="setting-row">
                        <div class="ios-text-box">
                            <div class="ios-title">心声模式</div>
                            <div class="ios-desc">开启后将产生内心独白</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="inner-thought-switch" onchange="toggleInnerThoughts(this)">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-row">
                        <div class="ios-text-box">
                            <div class="ios-title">自定义渲染</div>
                            <div class="ios-desc">应用正则脚本渲染心声卡片</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="inner-thought-custom-switch"
                                onchange="toggleInnerThoughtCustom(this)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-row" onclick="openThoughtFormatModal()">
                        <div class="ios-text-box">
                            <div class="ios-title">自定义心声格式</div>
                            <div class="ios-desc">设定 AI 输出心声的具体文案格式</div>
                        </div>
                        <svg class="ios-arrow" viewBox="0 0 24 24">
                            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                        </svg>
                    </div>
                    <div class="setting-row" onclick="openWorldBookMountSelector()">
                        <div class="ios-text-box">
                            <div class="ios-title">世界书挂载</div>
                            <div id="wb-mount-status" class="ios-desc">未挂载局部设定</div>
                        </div>
                        <svg class="ios-arrow" viewBox="0 0 24 24">
                            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                        </svg>
                    </div>
                    <div class="setting-row" onclick="openRegexMountSelector()">
                        <div class="ios-text-box">
                            <div class="ios-title">正则脚本挂载</div>
                            <div id="regex-mount-status" class="ios-desc">未挂载局部脚本</div>
                        </div>
                        <svg class="ios-arrow" viewBox="0 0 24 24">
                            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                        </svg>
                    </div>
                </div>

                <div style="margin: 0 0 8px 20px; font-size:13px; color:#888;">环境</div>
                <div class="ios-group">
                    <div class="setting-row">
                        <div class="ios-text-box">
                            <div class="ios-title">环境增强模式</div>
                            <div class="ios-desc">实时注入时间、天气和时差</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="env-mode-switch" onchange="toggleEnvMode(this)">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div id="env-settings-panel" style="display:none; background:#fff;">
                        <div id="view-mode-single" class="city-info-box">
                            <div class="flight-connector">
                                <svg class="flight-path-svg" viewBox="0 0 300 100" preserveAspectRatio="none">
                                    <path class="flight-line-bg" d="M 0,75 C 80,75 220,25 300,25" />
                                    <path class="flight-line-dash" d="M 0,75 C 80,75 220,25 300,25" />
                                </svg>
                                <div class="plane-wrapper">
                                    <svg viewBox="0 0 24 24" width="24" height="24">
                                        <path
                                            d="M21,16V14L13,9V3.5A1.5,1.5,0,0,0,11.5,2A1.5,1.5,0,0,0,10,3.5V9L2,14V16L10,13.5V19L8,20.5V22L11.5,21L15,22V20.5L13,19V13.5L21,16Z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="city-card" onclick="openCityModal('user')">
                                <div class="city-card-header">
                                    <div class="city-icon-bg"><svg viewBox="0 0 24 24" width="20" height="20"
                                            fill="#9B9ECE">
                                            <path
                                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                                        </svg></div>
                                    <div class="city-label-group">
                                        <div class="city-label-title">我的位置<svg class="verified-icon"
                                                viewBox="0 0 24 24">
                                                <path
                                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                                            </svg></div>
                                        <div id="ui-user-fake" class="city-name-main">未设置</div>
                                    </div>
                                </div>
                                <div id="ui-user-real" class="city-name-sub">映射: (空)</div>
                                <div id="ui-user-weather" class="city-weather-info">--</div>
                            </div>
                            <div class="city-card" onclick="openCityModal('char')">
                                <div class="city-card-header">
                                    <div class="city-icon-bg" style="background:#F4F4FF;"><svg viewBox="0 0 24 24"
                                            width="18" height="18" fill="#9B9ECE">
                                            <path
                                                d="M15 11V5l-3-3-3 3v2H3v14h18V11h-6zm-8 8H5v-2h2v2zm0-4H5v-2h2v2zm0-4H5V9h2v2zm6 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V9h2v2zm0-4h-2V5h2v2zm6 12h-2v-2h2v2zm0-4h-2v-2h2v2z" />
                                        </svg></div>
                                    <div class="city-label-group">
                                        <div class="city-label-title">对方位置<svg class="verified-icon"
                                                viewBox="0 0 24 24">
                                                <path
                                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                                            </svg></div>
                                        <div id="ui-char-fake" class="city-name-main">未设置</div>
                                    </div>
                                </div>
                                <div id="ui-char-real" class="city-name-sub">映射: (空)</div>
                                <div id="ui-char-weather" class="city-weather-info">--</div>
                            </div>
                        </div>

                        <div id="view-mode-group" style="display:none; padding:16px;">
                            <div class="city-card-wide" onclick="openCityModal('user')">
                                <div class="city-card-header">
                                    <div class="city-label-group">
                                        <div class="city-label-title">我的当前位置 (群同步)<svg class="verified-icon"
                                                viewBox="0 0 24 24" style="margin-left:6px;">
                                                <path
                                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                                            </svg></div>
                                        <div id="ui-user-fake-group" class="city-name-main"
                                            style="font-size:18px; margin-top:2px;">未设置</div>
                                    </div>
                                </div>
                                <div
                                    style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; border-top:1px solid #f9f9f9; padding-top:8px;">
                                    <div id="ui-user-real-group" class="city-name-sub">映射: (空)</div>
                                    <div id="ui-user-weather-group" class="city-weather-info" style="color:#9B9ECE;">--
                                    </div>
                                </div>
                            </div>
                            <div style="font-size:12px; color:#999; margin:20px 0 10px 4px;">其他成员位置</div>
                            <div id="env-group-list-container"></div>
                        </div>

                        <div style="padding:15px; font-size:12px; color:#999; line-height:1.5; text-align:center;">
                            💡 映射真实城市以获取实时天气
                        </div>
                    </div>
                </div>
                <div style="margin: 20px 0 8px 20px; font-size:13px; color:#888;">数据管理</div>
                <div class="ios-group">
                    <div class="setting-row" onclick="clearCurrentChatHistory()">
                        <div class="ios-text-box">
                            <div class="ios-title">清空聊天记录</div>
                            <div class="ios-desc">删除当前会话的所有消息 (不可恢复)</div>
                        </div>
                        <!-- 使用主题色的垃圾桶图标，而不是红色 -->
                        <div style="width:32px; height:32px; display:flex; align-items:center; justify-content:center;">
                            <svg class="ios-arrow" viewBox="0 0 24 24">
                                <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                            </svg>
                        </div>
                    </div>
                </div>
                <div id="modal-wb-mount" class="modal-overlay" style="z-index: 310;">
                    <div class="modal-card">
                        <div class="close-modal"
                            onclick="document.getElementById('modal-wb-mount').style.display='none'">×
                        </div>
                        <h3 style="margin-top:0;">选择局部设定</h3>
                        <p style="font-size:12px;color:#999;margin-bottom:15px;">勾选要挂载到当前会话的世界书 (全局设定默认生效)</p>
                        <div id="wb-mount-list" style="max-height:300px; overflow-y:auto;"></div>
                        <button class="btn-main" onclick="saveWbMount()">保存挂载</button>
                    </div>
                </div>

            </div>

            <div id="sub-page-visual" class="sub-page" style="background: #F2F2F7;">
                <div class="app-header" style="background: #fff;">
                    <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                    <div class="header-content">
                        <div class="header-left" onclick="event.stopPropagation(); closeSubPage('visual')"
                            style="width: 40px; padding-left: 5px;">
                            <svg viewBox="0 0 24 24" width="28" height="28">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                            </svg>
                        </div>
                        <div class="header-title"><span style="font-size:17px;font-weight:600;">头像与昵称</span></div>
                        <div class="header-right" onclick="saveVisualSettings()"
                            style="width:40px; display:flex; justify-content:center;">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="#9B9ECE">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="app-body" style="padding-top: 10px;">
                    <div style="margin: 10px 0 8px 24px; font-size:13px; color:#888;">选择要修改的对象</div>

                    <div
                        style="background: #fff; border-radius: 12px; margin: 0 16px 20px 16px; padding: 15px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div id="visual-target-container" class="visual-target-list" style="padding: 10px 16px;">
                        </div>
                    </div>

                    <div
                        style="background: #fff; border-radius: 12px; margin: 0 16px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">

                        <div style="display:flex; justify-content:center; margin-bottom:20px;">
                            <div style="position:relative;">
                                <div id="visual-preview"
                                    style="width:100px; height:100px; background:#eee; border-radius:50%; background-size:cover; background-position:center; border: 4px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                </div>
                                <div onclick="document.getElementById('visual-file-input').click()"
                                    style="position:absolute; bottom:0; right:0; width:32px; height:32px; background:var(--theme-purple); border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; border:2px solid #fff; cursor:pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.15);">
                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="white">
                                        <path
                                            d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                                    </svg>
                                </div>
                                <input type="file" id="visual-file-input" hidden accept="image/*"
                                    onchange="handleVisualAvatarFile(this)">
                            </div>
                        </div>

                        <div style="text-align:center; font-size:18px; font-weight:600; margin-bottom:25px; color:#333;"
                            id="visual-target-name">未知</div>

                        <label class="setting-label">显示昵称 (仅在本会话生效)</label>
                        <div class="input-wrapper">
                            <input type="text" id="visual-alias-input" class="setting-input" placeholder="默认为原名">
                        </div>

                        <div class="setting-row" style="padding: 10px 0; border-bottom: 1px solid #f9f9f9;">
                            <div class="ios-text-box">
                                <div class="ios-title" style="font-size:15px;">头像形状</div>
                            </div>
                            <div class="shape-selector">
                                <div id="shape-circle" class="shape-option active" onclick="setVisualShape('circle')">圆形
                                </div>
                                <div id="shape-square" class="shape-option" onclick="setVisualShape('square')">圆角</div>
                            </div>
                        </div>

                        <div class="setting-row" style="padding: 15px 0; border-bottom: 1px solid #f9f9f9;">
                            <div class="ios-text-box">
                                <div class="ios-title" style="font-size:15px;">头像大小</div>
                            </div>
                            <div style="display:flex; align-items:center; width: 140px;">
                                <input type="range" id="visual-size-slider" class="morandi-slider" min="30" max="60"
                                    step="2" oninput="updateVisualSizeVal(this.value)">
                                <span id="visual-size-val"
                                    style="width:40px; text-align:right; font-size:12px; color:#888;">40px</span>
                            </div>
                        </div>

                        <div class="setting-row" style="padding: 10px 0; border-bottom: none;">
                            <div class="ios-text-box">
                                <div class="ios-title" style="font-size:15px;">显示头像</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="visual-show-switch" checked
                                    onchange="toggleVisualVisibility(this)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <div style="padding:20px; text-align:center; color:#999; font-size:12px;">
                        设置仅对当前设备上的当前会话生效
                    </div>
                </div>
            </div>
        </div>
        <div id="app-moments" class="app-window" style="background: #ffffff;">
            <div class="app-header"
                style="background: rgba(255,255,255,0); position:fixed; top:0; left:0; width:100%; z-index:100; transition: background 0.3s;">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeApp('moments')">
                        <div class="glass-back-btn">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                            </svg>
                        </div>
                    </div>
                    <div class="header-title"><span style="opacity:0; transition:opacity 0.3s;"
                            id="moment-header-title">朋友圈</span></div>
                    <div class="header-right" id="moment-camera-btn" style="padding-right:15px; cursor: pointer;">
                        <div class="glass-back-btn">
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="white">
                                <path
                                    d="M12 9V7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5h-2c0 1.66-1.34 3-3 3s-3-1.34-3-3 1.34-3 3-3v-2l3 3-3 3v-2h-2" />
                                <path
                                    d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="app-body" id="moment-scroller" style="padding:0; padding-bottom:40px; background:#fff;">

                <div class="moment-hero">
                    <div class="moment-cover"></div>
                    <div class="moment-user-info">
                        <span class="moment-user-name" id="moment-me-name">Me</span>
                        <div class="moment-user-avatar" id="moment-me-avatar"></div>
                    </div>
                </div>

                <div id="moment-list-container" style="padding-top: 30px;">

                </div>
            </div>
        </div>

        <div id="app-moment-publish" class="app-window" style="background: #fff; z-index: 101;">
            <div class="app-header">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeApp('moment-publish')">
                        <span style="font-size:16px; color:#333;">取消</span>
                    </div>
                    <div class="header-title"></div>
                    <div class="header-right">
                        <button class="btn-main" onclick="submitMoment()"
                            style="width:60px; height:32px; padding:0; margin:0; font-size:14px; background:#9B9ECE;">发表</button>
                    </div>
                </div>
            </div>
            <div class="app-body" style="padding: 20px;">
                <textarea id="moment-text-input" placeholder="这一刻的想法..."
                    style="width:100%; border:none; outline:none; font-size:16px; min-height:100px; resize:none; font-family:inherit;"></textarea>

                <div id="moment-img-grid" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:20px;">
                    <div class="moment-add-img-btn" onclick="document.getElementById('moment-file-input').click()">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="#ccc">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                    </div>
                </div>
                <div class="moment-options-group">

                    <div class="moment-opt-row" onclick="openMomentLocationSelect()">
                        <div class="moment-opt-icon">
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="#333">
                                <path
                                    d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
                            </svg>
                        </div>
                        <div class="moment-opt-title">所在位置</div>
                        <div id="moment-loc-display" class="moment-opt-val"></div>
                        <svg class="moment-arrow" viewBox="0 0 24 24" width="20" height="20" fill="#ccc">
                            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                        </svg>
                    </div>

                    <div class="moment-opt-row" onclick="openMomentMentionSelect()">
                        <div class="moment-opt-icon">
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="#333">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" />
                            </svg>
                        </div>
                        <div class="moment-opt-title">提醒谁看</div>
                        <div id="moment-mention-display" class="moment-opt-val"></div>
                        <svg class="moment-arrow" viewBox="0 0 24 24" width="20" height="20" fill="#ccc">
                            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                        </svg>
                    </div>
                    <div class="moment-opt-row" onclick="openMomentScopeSelect()">
                        <div class="moment-opt-icon">
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="#333">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
                            </svg>
                        </div>
                        <div class="moment-opt-title">谁可以看</div>
                        <div id="moment-scope-display" class="moment-opt-val">公开</div>
                        <svg class="moment-arrow" viewBox="0 0 24 24" width="20" height="20" fill="#ccc">
                            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                        </svg>
                    </div>
                </div>
                <input type="file" id="moment-file-input" hidden accept="image/*" multiple
                    onchange="handleMomentImgSelect(this)">
            </div>
        </div>
        <div id="modal-city-select" class="modal-overlay" style="z-index: 300;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-city-select').style.display='none'">×
                </div>
                <h3 style="margin-top:0;">定位设置</h3>

                <label class="setting-label">显示名称 (Roleplay用)</label>
                <div class="input-wrapper">
                    <input type="text" id="city-fake-input" class="setting-input" placeholder="例如：哥谭市 / 魔法学院">
                </div>

                <label class="setting-label">真实映射城市 (API查询用)</label>
                <div class="input-wrapper">
                    <input type="text" id="city-real-input" class="setting-input"
                        placeholder="例如：New York / London / Beijing">
                </div>
                <p style="font-size:12px;color:#999;margin-bottom:15px;">请填写英文城市名或拼音 (如 Shanghai)，以便API准确识别。</p>

                <button class="btn-main" onclick="saveCitySelection()">保存设定</button>
            </div>
        </div>
        <div id="app-worldbook" class="app-window" style="background: #F9F9FC;">
            <div class="app-header">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeApp('worldbook')">
                        <svg viewBox="0 0 24 24" width="28" height="28">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                    </div>
                    <div class="header-title"><span style="font-size:17px;font-weight:600;">世界书</span></div>
                    <div class="header-right" style="gap:15px; padding-right:10px;">
                        <div id="wb-btn-select" onclick="toggleWbSelectMode()"
                            style="cursor:pointer; display:flex; color:var(--theme-purple);">
                            <svg viewBox="0 0 24 24" width="26" height="26" fill="currentColor">
                                <path
                                    d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z" />
                            </svg>
                        </div>
                        <div id="wb-btn-add" onclick="openWorldBookEdit()" style="cursor:pointer; display:flex;">
                            <svg viewBox="0 0 24 24" width="26" height="26" fill="#9B9ECE">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <div style="flex-shrink: 0; padding: 10px 16px 0 16px; background: #F9F9FC; z-index: 10;">
                <div class="avatar-tabs" style="margin-bottom:10px;">
                    <div class="avatar-tab active" id="wb-tab-global" onclick="switchWorldBookTab('global')">全局设定</div>
                    <div class="avatar-tab" id="wb-tab-local" onclick="switchWorldBookTab('local')">局部设定</div>
                </div>

                <div id="wb-category-bar" class="category-scroll-container">
                </div>
            </div>

            <div class="app-body" style="padding: 0 16px;">
                <div id="worldbook-list-container" style="padding-bottom: 80px;"></div>
            </div>

            <div id="wb-bottom-bar" class="wb-bottom-bar">
                <div class="wb-bar-btn" onclick="openWbMoveModal()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="#666">
                        <path
                            d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z" />
                    </svg>
                    <span>移动分类</span>
                </div>
                <div class="wb-bar-btn danger" onclick="batchDeleteWb()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#FF3B30" stroke-width="2">
                        <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                    </svg>
                    <span>删除</span>
                </div>
            </div>
        </div>

        <div id="modal-cat-mgr" class="modal-overlay" style="z-index: 400;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-cat-mgr').style.display='none'">×</div>
                <h3 style="margin-top:0;">分类管理</h3>

                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="new-cat-name" class="setting-input" placeholder="新分类名称"
                        style="height:40px; margin:0;">
                    <button class="btn-main" onclick="addNewCategory()"
                        style="width:80px; margin:0; padding:0;">添加</button>
                </div>

                <div style="font-size:12px;color:#999;margin-bottom:8px;">删除分类时，其下内容会自动移入默认分类</div>

                <div id="cat-mgr-list"
                    style="max-height:300px; overflow-y:auto; border:1px solid #f0f0f0; border-radius:12px;">
                </div>
            </div>
        </div>

        <div id="modal-wb-move" class="modal-overlay" style="z-index: 410;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-wb-move').style.display='none'">×</div>
                <h3>移动到...</h3>
                <div id="move-cat-list" style="max-height:300px; overflow-y:auto;">
                </div>
            </div>
        </div>

        <div id="app-worldbook-edit" class="app-window" style="background: #F9F9FC;">
            <div class="app-header">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeApp('worldbook-edit')">
                        <svg viewBox="0 0 24 24" width="28" height="28">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                    </div>

                    <div class="header-title"><span id="wb-edit-title"
                            style="font-size:17px;font-weight:600;">编辑词条</span></div>

                    <div class="header-right"
                        style="width: auto; min-width: 40px; display: flex; align-items: center; justify-content: flex-end; gap: 16px; padding-right: 10px;">
                        <div id="btn-del-wb" onclick="deleteWorldBookEntry()"
                            style="display:none; cursor:pointer; padding: 4px;">
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#B26B61"
                                stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </div>

                        <div onclick="saveWorldBookEntry()" style="cursor:pointer; display:flex;">
                            <svg viewBox="0 0 24 24" width="26" height="26" fill="#9B9ECE">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class="app-body" style="padding: 20px 16px;">
                <div class="wb-edit-type-segment">
                    <div id="wb-edit-segment-global" class="wb-edit-segment-item active"
                        onclick="switchWbEditType('global')">全局设定</div>
                    <div id="wb-edit-segment-local" class="wb-edit-segment-item" onclick="switchWbEditType('local')">
                        局部设定</div>
                </div>
                <label class="setting-label">词条名称</label>
                <div class="input-wrapper">
                    <input type="text" id="wb-name" class="setting-input" placeholder="例如：魔法原理 / 家族历史">
                </div>
                <label class="setting-label">所属分类</label>
                <div class="input-wrapper">
                    <select id="wb-category-select" class="setting-input" style="background-image:none;">
                    </select>
                </div>
                <label class="setting-label">触发机制</label>
                <div class="settings-card" style="margin:0 0 16px 0;">
                    <div class="settings-item">
                        <div class="settings-text">
                            <h4>常驻激活 (Constant)</h4>
                            <p>无需触发词，永远注入到Prompt中</p>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="wb-constant" onchange="toggleWbKeywords(this)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div id="wb-keyword-group">
                    <label class="setting-label">触发关键词 (英文逗号分隔)</label>
                    <div class="input-wrapper">
                        <input type="text" id="wb-keys" class="setting-input" placeholder="例如：魔法, 吟唱, mana">
                    </div>
                </div>

                <label class="setting-label">内容设定 (Content)</label>
                <div class="input-wrapper">
                    <textarea id="wb-content" class="setting-input" style="height:150px; line-height:1.5;"
                        placeholder="输入该词条的具体设定内容..."></textarea>
                </div>

                <label class="setting-label">高级选项</label>
                <div class="settings-card" style="margin:0;">
                    <div class="settings-item">
                        <div class="settings-text">
                            <h4>注入位置</h4>
                            <p>影响AI认知的优先级</p>
                        </div>
                        <select id="wb-position"
                            style="border:none; bg:transparent; text-align:right; font-size:14px; color:#666;">
                            <option value="top">顶部</option>
                            <option value="bottom">底部</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <div class="settings-text">
                            <h4>注入权重 (Order)</h4>
                            <p>数字越大越靠后</p>
                        </div>
                        <input type="number" id="wb-order" value="100"
                            style="width:50px; border:none; text-align:right;">
                    </div>
                </div>


            </div>
        </div>
        <div id="msg-context-menu-overlay" class="msg-menu-overlay" style="display: none;" onclick="hideMsgMenu()">
            <div id="msg-menu-box" class="msg-menu-box">
                <div class="msg-menu-item" onclick="handleCopyMsg()" style="justify-content: center;">
                    <span>复制</span>
                </div>
                <div class="msg-menu-line"></div>
                <div class="msg-menu-item" onclick="handleQuoteMsg()" style="justify-content: center;">
                    <span>引用</span>
                </div>
                <div class="msg-menu-line"></div>
                <div id="menu-btn-recall" class="msg-menu-item" onclick="handleRecallMsg()"
                    style="justify-content: center; display:none;">
                    <span>撤回</span>
                </div>
                <div class="msg-menu-item" onclick="enterMultiSelectMode()" style="justify-content: center;">
                    <span>多选</span>
                </div>
                <div class="msg-menu-line"></div>
                <div id="menu-line-recall" class="msg-menu-line" style="display:none;"></div>
                <div class="msg-menu-item" onclick="handleDeleteMsg()" style="justify-content: center;">
                    <span>删除</span>
                </div>
            </div>
        </div>
        <div id="app-sticker-mgr" class="app-window" style="background: #F9F9FC;">
            <div class="app-header">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeApp('sticker-mgr')">
                        <svg viewBox="0 0 24 24" width="28" height="28">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                    </div>
                    <div class="header-title"><span style="font-size:17px;font-weight:600;">表情库</span></div>

                    <div class="header-right" style="gap:15px; padding-right:10px;">
                        <div id="st-btn-select" onclick="toggleStickerSelectMode()"
                            style="cursor:pointer; display:flex; color:var(--theme-purple);">
                            <svg class="icon-default" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                                <path
                                    d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z" />
                            </svg>
                        </div>
                        <div id="st-btn-add" onclick="showAddStickerModal()" style="cursor:pointer; display:flex;">
                            <svg viewBox="0 0 24 24" width="26" height="26" fill="#9B9ECE">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <div style="flex-shrink: 0; padding: 10px 16px 0 16px; background: #F9F9FC; z-index: 10;">
                <div id="sticker-pack-bar" class="category-scroll-container"></div>
            </div>

            <div class="app-body" style="padding: 10px 16px;">
                <div id="sticker-grid-container" class="sticker-grid"></div>
            </div>

            <div id="st-bottom-bar" class="wb-bottom-bar">
                <div class="wb-bar-btn" onclick="openStickerMoveModal()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="#666">
                        <path
                            d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z" />
                    </svg>
                    <span>移动到...</span>
                </div>
                <div class="wb-bar-btn" onclick="selectAllStickers()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="#666">
                        <path
                            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                    </svg>
                    <span>全选</span>
                </div>
                <div class="wb-bar-btn danger" onclick="batchDeleteStickers()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#FF3B30" stroke-width="2">
                        <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                    </svg>
                    <span>删除</span>
                </div>
            </div>

            <div id="modal-sticker-add" class="modal-overlay" style="z-index: 500;">
                <div class="modal-card"
                    style="display: flex; flex-direction: column; padding: 0; max-height: 85vh; overflow: hidden;">

                    <div style="padding: 20px 20px 0 20px; flex-shrink: 0; position: relative;">
                        <div class="close-modal"
                            onclick="document.getElementById('modal-sticker-add').style.display='none'"
                            style="top: 15px; right: 20px;">×</div>

                        <h3 style="margin-top:0;">管理表情</h3>

                        <div class="wb-edit-type-segment" style="margin-bottom:10px;">
                            <div id="st-tab-item" class="wb-edit-segment-item active"
                                onclick="switchStickerAddTab('item')">单张</div>
                            <div id="st-tab-batch" class="wb-edit-segment-item" onclick="switchStickerAddTab('batch')">
                                批量</div>
                            <div id="st-tab-backup" class="wb-edit-segment-item"
                                onclick="switchStickerAddTab('backup')">备份</div>
                        </div>
                    </div>

                    <div
                        style="flex: 1; overflow-y: auto; padding: 10px 20px 20px 20px; -webkit-overflow-scrolling: touch;">

                        <div id="form-sticker-item">
                            <div style="display:flex; gap:15px; margin-bottom:15px; align-items:flex-start;">
                                <div style="flex-shrink:0; text-align:center;">
                                    <div id="st-upload-box" onclick="document.getElementById('st-file-input').click()"
                                        style="width:80px; height:80px; background:#f9f9f9; border:1px dashed #ccc; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;">
                                        <img id="st-preview" src=""
                                            style="width:100%; height:100%; object-fit:contain; display:none;">
                                        <div id="st-ph"
                                            style="color:#999; font-size:10px; display:flex; flex-direction:column; align-items:center;">
                                            <svg viewBox="0 0 24 24" width="20" height="20" fill="#ccc"
                                                style="margin-bottom:2px;">
                                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                                            </svg>
                                            <span>上传</span>
                                        </div>
                                    </div>
                                    <input type="file" id="st-file-input" hidden accept="image/*"
                                        onchange="handleStickerFile(this)">
                                </div>
                                <div style="flex-grow:1;">
                                    <label class="setting-label" style="margin-bottom:6px; display:block;">表情名称</label>
                                    <input type="text" id="st-item-name" class="setting-input" placeholder="未命名"
                                        style="height:40px; font-size:14px; margin-bottom:8px;">
                                    <div style="font-size:11px; color:#aaa; line-height:1.4;">支持 JPG, PNG, GIF<br>建议尺寸
                                        240x240</div>
                                </div>
                            </div>
                            <div style="background:#F9F9FC; border-radius:10px; padding:10px 12px; margin-bottom:15px;">
                                <div style="display:flex; align-items:center; margin-bottom:4px;">
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="#999"
                                        style="margin-right:4px;">
                                        <path
                                            d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z" />
                                    </svg>
                                    <span style="font-size:12px; color:#888; font-weight:500;">网络图片链接 (可选)</span>
                                </div>
                                <input type="text" id="st-url-input" class="setting-input"
                                    placeholder="粘贴以 http 开头的图片链接" oninput="handleStickerUrl(this)"
                                    style="height:36px; font-size:13px; border:1px solid #eee; background:#fff; margin-bottom:0;">
                            </div>
                            <button class="btn-main" onclick="saveStickerItem()">保存到当前库</button>
                        </div>

                        <div id="form-sticker-batch" style="display:none;">
                            <label class="setting-label">批量文本 (格式：名称: 链接)</label>
                            <div class="input-wrapper">
                                <textarea id="st-batch-input" class="setting-input"
                                    style="height:150px; line-height:1.4; font-size:13px; white-space:pre-wrap; word-break:break-all; overflow-y:auto;"
                                    placeholder="例如：&#10;开心: http://example.com/1.jpg&#10;难过: http://example.com/2.jpg"></textarea>
                            </div>
                            <button class="btn-main" onclick="saveStickerBatch()">开始批量导入</button>
                        </div>

                        <div id="form-sticker-backup" style="display:none; padding-top:10px;">
                            <div onclick="exportCurrentPack()"
                                style="display:flex; align-items:center; background:#F9F9FC; padding:12px 16px; border-radius:12px; margin-bottom:10px; cursor:pointer; border:1px solid #f0f0f0;">
                                <div
                                    style="width:36px; height:36px; background:#fff; border-radius:10px; display:flex; align-items:center; justify-content:center; margin-right:12px; flex-shrink:0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                    <svg viewBox="0 0 24 24" width="20" height="20" fill="#9B9ECE">
                                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                                    </svg>
                                </div>
                                <div style="flex-grow:1;">
                                    <div style="font-size:15px; font-weight:600; color:#333;">导出当前表情库</div>
                                    <div style="font-size:12px; color:#999;">生成 .json 备份文件</div>
                                </div>
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="#ccc">
                                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                                </svg>
                            </div>

                            <div
                                style="position:relative; display:flex; align-items:center; background:#F9F9FC; padding:12px 16px; border-radius:12px; margin-bottom:10px; cursor:pointer; border:1px solid #f0f0f0;">
                                <input type="file" id="json-import-input" accept=".json"
                                    onchange="importStickerPack(this)"
                                    style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                                <div
                                    style="width:36px; height:36px; background:#fff; border-radius:10px; display:flex; align-items:center; justify-content:center; margin-right:12px; flex-shrink:0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                    <svg viewBox="0 0 24 24" width="20" height="20" fill="#9B9ECE">
                                        <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" />
                                    </svg>
                                </div>
                                <div style="flex-grow:1;">
                                    <div style="font-size:15px; font-weight:600; color:#333;">导入表情库</div>
                                    <div style="font-size:12px; color:#999;">读取 .json 还原数据</div>
                                </div>
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="#ccc">
                                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                                </svg>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div id="modal-sticker-move" class="modal-overlay" style="z-index: 510;">
                <div class="modal-card">
                    <div class="close-modal"
                        onclick="document.getElementById('modal-sticker-move').style.display='none'">×</div>
                    <h3>移动到...</h3>
                    <div id="st-move-list" style="max-height:300px; overflow-y:auto;"></div>
                </div>
            </div>

            <div id="sticker-preview-overlay" class="preview-overlay" onclick="this.style.display='none'">
                <img id="sticker-preview-img" src="">
                <div style="color:white; margin-top:20px; font-size:14px; opacity:0.8;">点击任意处关闭</div>
            </div>
        </div>
        <div id="modal-st-pack-mgr" class="modal-overlay" style="z-index: 600;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-st-pack-mgr').style.display='none'">×
                </div>
                <h3 style="margin-top:0;">管理表情库</h3>

                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="quick-pack-name" class="setting-input" placeholder="新分类名称"
                        style="height:40px; margin:0;">
                    <button class="btn-main" onclick="quickAddStickerPack()"
                        style="width:80px; margin:0; padding:0;">添加</button>
                </div>

                <div style="font-size:12px;color:#999;margin-bottom:8px;">点击右侧图标删除分类 (不可恢复)</div>

                <div id="st-pack-mgr-list" style="
    max-height: 50vh; 
    overflow-y: auto; 
    border: 1px solid #f0f0f0; 
    border-radius: 12px;
    margin-top: 10px;
">
                </div>
            </div>
        </div>
        <div id="modal-voice-input" class="modal-overlay" style="z-index: 700;">
            <div class="modal-card" style="padding: 0; overflow: hidden;">

                <div style="padding: 24px 24px 0 24px; position: relative; background: #fff; z-index: 10;">
                    <div class="close-modal" onclick="document.getElementById('modal-voice-input').style.display='none'"
                        style="top: 20px; right: 20px;">×</div>

                    <h3 style="margin-top:0;">录制语音</h3>
                </div>

                <div
                    style="flex: 1; overflow-y: auto; padding: 20px 24px 24px 24px; -webkit-overflow-scrolling: touch;">

                    <div style="display:flex; flex-direction:column; align-items:center; margin-bottom: 20px;">
                        <div
                            style="width:60px; height:60px; background:#9B9ECE; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 15px rgba(155, 158, 206, 0.4);">
                            <svg viewBox="0 0 24 24" width="30" height="30" fill="white">
                                <path
                                    d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.66 9 5v6c0 1.66 1.34 3 3 3z" />
                                <path
                                    d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                            </svg>
                        </div>
                        <div style="font-size:12px; color:#999; margin-top:10px;">语音转文字中...</div>
                    </div>

                    <label class="setting-label">识别内容</label>
                    <div class="input-wrapper">
                        <textarea id="voice-text-input" class="setting-input" style="height:80px; padding-top:10px;"
                            placeholder="点击此处编辑语音内容..."></textarea>
                    </div>

                    <button class="btn-main" onclick="submitVoiceInput()" style="background:#9B9ECE;">发送语音</button>
                </div>

            </div>
        </div>
        <div id="modal-photo-card" class="modal-overlay" style="z-index: 750;">
            <div class="modal-card"
                style="padding: 0; display: flex; flex-direction: column; overflow: hidden; max-height: 85vh;">

                <div
                    style="padding: 20px 20px 0 20px; flex-shrink: 0; position: relative; background: #fff; z-index: 10;">
                    <div class="close-modal" onclick="document.getElementById('modal-photo-card').style.display='none'"
                        style="top: 15px; right: 20px;">×</div>

                    <h3 style="margin-top:0; margin-bottom: 15px;">发送内容</h3>

                    <div class="wb-edit-type-segment" style="margin-bottom:10px;">
                        <div id="tab-photo-local" class="wb-edit-segment-item active" onclick="switchPhotoTab('local')">
                            本地图片</div>
                        <div id="tab-photo-card" class="wb-edit-segment-item" onclick="switchPhotoTab('card')">图文卡片
                        </div>
                    </div>
                </div>

                <div
                    style="flex: 1; overflow-y: auto; padding: 10px 20px 20px 20px; -webkit-overflow-scrolling: touch;">

                    <div id="panel-photo-local">
                        <div onclick="document.getElementById('inp-local-img').click()"
                            style="width:100%; height:140px; background:#f9f9f9; border:2px dashed #eee; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; position:relative;">

                            <img id="preview-local-img"
                                style="width:100%; height:100%; object-fit:contain; display:none;">

                            <div id="placeholder-local-img"
                                style="display:flex; flex-direction:column; align-items:center; color:#ccc;">
                                <svg viewBox="0 0 24 24" width="30" height="30" fill="#ddd">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                                </svg>
                                <span style="font-size:12px; margin-top:6px;">点击选择图片</span>
                            </div>
                        </div>
                        <input type="file" id="inp-local-img" hidden accept="image/*"
                            onchange="handleLocalImgFile(this)">
                        <p style="font-size:12px; color:#999; margin-top:8px; text-align:center;">AI 将在回复时识别这张图片</p>
                    </div>

                    <div id="panel-photo-card" style="display:none;">
                        <div style="display:flex; justify-content:center; margin: 10px 0;">
                            <img src="https://file.icve.com.cn/file_doc/qdqqd/2161767359654214.jpeg"
                                style="width:100px; height:100px; border-radius:12px; object-fit:cover;">
                        </div>
                        <label class="setting-label">卡片隐藏内容</label>
                        <div class="input-wrapper">
                            <textarea id="photo-card-desc" class="setting-input"
                                style="height:80px; padding-top:10px; line-height:1.5;"
                                placeholder="输入这段文字，只有点击图片后才能看到..."></textarea>
                        </div>
                    </div>

                    <button class="btn-main" onclick="submitPhotoUnified()" style="margin-top:15px;">发送</button>
                    <div style="height: 20px;"></div>
                </div>
            </div>
        </div>

        <div id="modal-card-detail" class="modal-overlay" style="z-index: 800; align-items: center;">
            <div class="modal-card" style="background: #fff; text-align: center; padding: 30px 20px;">
                <div class="close-modal" onclick="document.getElementById('modal-card-detail').style.display='none'">×
                </div>

                <div
                    style="width:60px; height:60px; background:#F4F4FF; border-radius:50%; margin:0 auto 20px auto; display:flex; align-items:center; justify-content:center;">
                    <svg viewBox="0 0 24 24" width="30" height="30" fill="#9B9ECE">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
                    </svg>
                </div>

                <h3 style="margin:0 0 10px 0; color:#333;">详细内容</h3>
                <p id="card-detail-text"
                    style="font-size:15px; color:#555; line-height:1.6; text-align: left; background: #F9F9FC; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                </p>

                <button class="btn-main" onclick="document.getElementById('modal-card-detail').style.display='none'"
                    style="background:#f0f0f0; color:#666;">关闭</button>
            </div>
        </div>
        <div id="global-image-viewer" class="preview-overlay" onclick="this.style.display='none'">
            <img id="global-image-viewer-img" src="" onclick="event.stopPropagation()">
            <div class="viewer-close-btn" onclick="document.getElementById('global-image-viewer').style.display='none'">
                ×</div>
        </div>
        <div id="app-wallet" class="app-window" style="background: #F9F9FC;">
            <div class="app-header">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeApp('wallet')">
                        <svg viewBox="0 0 24 24" width="28" height="28">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                    </div>
                    <div class="header-title"><span style="font-size:17px;font-weight:600;">我的钱包</span></div>
                    <div class="header-right" style="width:40px;"></div>
                </div>
            </div>

            <div class="app-body" style="padding-bottom: 40px;">
                <div class="wallet-card-main">
                    <div class="wallet-balance-label">总资产 (Credits)</div>
                    <div id="wallet-balance-val" class="wallet-balance-num">0.00</div>
                </div>

                <div class="wallet-action-grid">
                    <div class="wallet-action-item" onclick="openWalletAction('income')">
                        <div class="wallet-icon-box">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg>
                        </div>
                        <span class="wallet-action-text">充值/收入</span>
                    </div>
                    <div class="wallet-action-item" onclick="openWalletAction('expense')">
                        <div class="wallet-icon-box">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
                                <path d="M19 13H5v-2h14v2z" />
                            </svg>
                        </div>
                        <span class="wallet-action-text">转账/支出</span>
                    </div>

                    <div class="wallet-action-item" onclick="openWalletPasswordSettings()">
                        <div class="wallet-icon-box" style="background: #F2F2F7; color: #666;">
                            <svg viewBox="0 0 24 24" width="26" height="26" fill="currentColor">
                                <path
                                    d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
                            </svg>
                        </div>
                        <span class="wallet-action-text">支付密码</span>
                    </div>
                </div>

                <div class="trans-list-header">
                    <span>近期账单</span>
                    <span style="font-size:12px; color:#999; font-weight:normal;">查看全部 ></span>
                </div>

                <div id="wallet-trans-list">
                </div>
            </div>
        </div>

        <div id="modal-wallet-action" class="modal-overlay" style="z-index: 900;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-wallet-action').style.display='none'">×
                </div>
                <h3 id="wallet-modal-title" style="margin-top:0;">交易</h3>

                <label class="setting-label">金额</label>
                <div class="input-wrapper">
                    <input type="number" id="wallet-amount" class="setting-input" placeholder="0.00">
                </div>

                <label class="setting-label">备注</label>
                <div class="input-wrapper">
                    <input type="text" id="wallet-note" class="setting-input" placeholder="例如：任务报酬 / 购买装备">
                </div>

                <button class="btn-main" onclick="submitWalletTransaction()">确认</button>
            </div>
        </div>
        <div id="modal-wallet-pw-set" class="modal-overlay" style="z-index: 910;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-wallet-pw-set').style.display='none'">×
                </div>
                <h3 style="margin-top:0;">设置全局支付密码</h3>
                <p style="font-size:12px; color:#999; margin-bottom:15px;">设置后，所有角色的支出/转账操作都需要验证此密码。留空保存则取消密码。</p>

                <label class="setting-label">输入新密码</label>
                <div class="input-wrapper">
                    <input type="password" id="wallet-pw-new" class="setting-input" placeholder="留空则为无密码">
                </div>

                <button class="btn-main" onclick="saveWalletPassword()">保存设置</button>
            </div>
        </div>

        <div id="modal-wallet-auth" class="modal-overlay" style="z-index: 920;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-wallet-auth').style.display='none'">×
                </div>
                <h3 style="margin-top:0;">安全验证</h3>
                <p style="font-size:13px; color:#666; margin-bottom:15px;">请输入支付密码以确认交易</p>

                <div class="input-wrapper">
                    <input type="password" id="wallet-pw-auth" class="setting-input" placeholder="请输入密码">
                </div>

                <button class="btn-main" onclick="verifyWalletPasswordAndSubmit()">确认支付</button>
            </div>
        </div>
        <div id="modal-transfer-input" class="modal-overlay" style="z-index: 850;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-transfer-input').style.display='none'">
                    ×</div>
                <h3 style="margin-top:0;">发起转账</h3>

                <div id="transfer-target-wrapper" style="display:none;">
                    <label class="setting-label">接收人</label>
                    <div class="input-wrapper">
                        <select id="transfer-target-select" class="setting-input" style="background-image:none;">
                        </select>
                    </div>
                </div>

                <label class="setting-label">金额</label>
                <div class="input-wrapper">
                    <input type="number" id="transfer-amount" class="setting-input" placeholder="0.00">
                </div>

                <label class="setting-label">备注</label>
                <div class="input-wrapper">
                    <input type="text" id="transfer-note" class="setting-input" placeholder="例如：请你喝奶茶">
                </div>

                <button class="btn-main" onclick="submitTransferInput()">下一步</button>
            </div>
        </div>
        <div id="modal-transfer-receive" class="modal-overlay" style="z-index: 900; display: none;">
            <div class="modal-card transfer-receive-modal">
                <div class="close-modal" onclick="closeTransferModal()">×</div>

                <div class="tr-icon-top">
                    <svg viewBox="0 0 24 24" width="40" height="40" fill="#9B9ECE">
                        <path d="M12.5 16h-2v-2h2v2zm0-4h-2V7h2v5z" />
                        <path d="M7 2v11h3v9l7-12h-4l4-8z" />
                    </svg>
                </div>

                <div class="tr-desc-label">收到转账</div>
                <div class="tr-amount" id="tr-amount">¥0.00</div>
                <div class="tr-note" id="tr-note">备注信息</div>

                <button class="btn-main" style="margin-top: 30px;" onclick="confirmReceive()">确认收款</button>

                <div class="tr-footer-link" onclick="confirmReturn()">
                    立即退还
                </div>
            </div>
        </div>
        <div id="modal-moment-loc" class="modal-overlay" style="z-index: 600;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-moment-loc').style.display='none'">×
                </div>
                <h3 style="margin-top:0;">所在位置</h3>
                <div id="loc-list-container" style="max-height:300px; overflow-y:auto;">
                    <!-- 动态生成 -->
                </div>
                <div class="wb-bar-btn" onclick="selectMomentLocation(null)" style="margin-top:10px; color:#999;">不显示位置
                </div>
            </div>
        </div>

        <!-- 提醒谁看模态窗 -->
        <div id="modal-moment-mention" class="modal-overlay" style="z-index: 600;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-moment-mention').style.display='none'">
                    ×</div>
                <h3 style="margin-top:0;">提醒谁看</h3>
                <p style="font-size:12px;color:#999;margin-bottom:10px;">选择要提醒的好友 (多选)</p>
                <div id="mention-list-container" style="max-height:300px; overflow-y:auto;"></div>
                <button class="btn-main" onclick="confirmMentions()">确定</button>
            </div>
        </div>
        <!-- 评论输入弹窗 -->
        <div id="modal-comment-input" class="modal-overlay"
            style="z-index: 1100; align-items: flex-end; padding:0; background: rgba(0,0,0,0.2);">
            <div
                style="width: 100%; background: #fff; padding: 10px; box-sizing: border-box; display: flex; align-items: flex-end; gap: 10px; padding-bottom: calc(10px + env(safe-area-inset-bottom));">
                <textarea id="comment-textarea"
                    style="flex-grow:1; background:#f5f5f5; border:none; border-radius:8px; padding:10px; font-size:16px; height:40px; resize:none; font-family:inherit; outline:none;"
                    placeholder="评论..."></textarea>
                <button class="btn-main" onclick="submitComment()"
                    style="width:60px; height:40px; margin:0; padding:0; font-size:14px;">发送</button>
            </div>
            <!-- 点击遮罩关闭 -->
            <div style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:-1;"
                onclick="closeCommentInput()"></div>
        </div>
        <div id="modal-group-mgr" class="modal-overlay" style="z-index: 600;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-group-mgr').style.display='none'">×
                </div>
                <h3 style="margin-top:0;">管理好友分组</h3>

                <!-- 添加区域 -->
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="new-group-name-input" class="setting-input" placeholder="新分组名称"
                        style="height:40px; margin:0;">
                    <button class="btn-main" onclick="submitAddGroup()"
                        style="width:80px; margin:0; padding:0;">添加</button>
                </div>

                <div style="font-size:12px;color:#999;margin-bottom:8px;">已有分组 (点击右侧图标删除)</div>

                <!-- 列表区域 -->
                <div id="group-mgr-list"
                    style="max-height: 300px; overflow-y: auto; border: 1px solid #f0f0f0; border-radius: 12px;">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>
        <div id="modal-relation-graph" class="modal-overlay"
            style="z-index: 2000; background: #F2F2F7; align-items: flex-start; overflow: hidden;">
            <!-- 顶部导航栏 (悬浮) -->
            <div
                style="position: absolute; top: 0; left: 0; width: 100%; height: auto; z-index: 100; padding-top: env(safe-area-inset-top); pointer-events: none;">
                <div style="height: 44px; display: flex; align-items: center; padding: 0 10px; pointer-events: auto;">
                    <div class="header-left" onclick="closeRelationGraph()">
                        <div class="glass-back-btn"
                            style="background: rgba(255,255,255,0.8); box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="#333">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                            </svg>
                        </div>
                    </div>
                    <div class="header-title"><span style="font-size:17px;font-weight:600; color:#333;">人物关系网</span>
                    </div>
                    <div class="header-right" onclick="centerGraph()"
                        style="width:40px; display:flex; justify-content:center;">
                        <div class="glass-back-btn"
                            style="background: rgba(255,255,255,0.8); box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="#333">
                                <path
                                    d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7 7-7z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 可拖拽画布 -->
            <div id="relation-viewport"
                style="width: 100%; height: 100%; overflow: hidden; cursor: grab; touch-action: none;">
                <div id="relation-canvas"
                    style="width: 2000px; height: 2000px; position: absolute; transform-origin: 0 0;">
                    <!-- SVG 层用于画线 -->
                    <svg id="relation-lines-layer"
                        style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none;"></svg>
                    <!-- 节点容器 -->
                    <div id="relation-nodes-layer" style="position: absolute; top:0; left:0; width:100%; height:100%;">
                    </div>
                </div>
            </div>

            <!-- 底部操作栏 -->
            <div
                style="position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; pointer-events: none;">
                <button class="btn-main" onclick="openAddRelationModal()"
                    style="width: auto; padding: 10px 24px; border-radius: 24px; box-shadow: 0 5px 20px rgba(155, 158, 206, 0.4); pointer-events: auto;">
                    + 添加新关系
                </button>
            </div>
        </div>

        <!-- 添加关系的弹窗 -->
        <div id="modal-add-rel" class="modal-overlay" style="z-index: 2100;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-add-rel').style.display='none'">×</div>
                <h3 style="margin-top:0;">建立羁绊</h3>

                <label class="setting-label">当前角色</label>
                <div id="rel-curr-name" style="font-size:16px; font-weight:bold; margin-bottom:15px; color:#333;"></div>

                <label class="setting-label">关联对象 (好友/NPC)</label>
                <div class="input-wrapper">
                    <select id="rel-target-select" class="setting-input" style="background-image:none;"></select>
                </div>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <!-- 加上 id="label-rel-to-me" -->
                        <label id="label-rel-to-me" class="setting-label" style="font-size:12px;">对方是TA的...</label>
                        <input type="text" id="rel-input-to-me" class="setting-input">
                    </div>
                    <div style="flex:1;">
                        <!-- 加上 id="label-rel-to-him" -->
                        <label id="label-rel-to-him" class="setting-label" style="font-size:12px;">TA是对方的...</label>
                        <input type="text" id="rel-input-to-him" class="setting-input">
                    </div>
                </div>

                <button class="btn-main" onclick="submitNewRelation()">确认连接</button>

            </div>
        </div>
        <div id="modal-edit-rel" class="modal-overlay" style="z-index: 2200;">
            <div class="modal-card">
                <!-- 统一的关闭按钮 -->
                <div class="close-modal" onclick="document.getElementById('modal-edit-rel').style.display='none'">×
                </div>

                <!-- 统一的标题样式 -->
                <h3 style="margin-top:0;">调整羁绊</h3>

                <!-- 动态显示的说明文字 -->
                <div id="edit-rel-target-name"
                    style="text-align:center; color:#9B9ECE; margin-bottom:20px; font-size:14px; font-weight: 500;">
                    正在加载...
                </div>

                <!-- 表单区域 -->
                <div
                    style="background: #F9F9FC; border-radius: 16px; padding: 16px; margin-bottom: 20px; border: 1px solid #eee;">

                    <label class="setting-label" id="lbl-edit-to-me" style="margin-top:0;">对方是TA的...</label>
                    <div class="input-wrapper" style="margin-bottom: 12px;">
                        <input type="text" id="inp-edit-to-me" class="setting-input" style="height: 40px;">
                    </div>

                    <label class="setting-label" id="lbl-edit-to-him">TA是对方的...</label>
                    <div class="input-wrapper" style="margin-bottom: 0;">
                        <input type="text" id="inp-edit-to-him" class="setting-input" style="height: 40px;">
                    </div>
                </div>

                <!-- 按钮组 -->
                <div class="modal-action-bar" style="flex-shrink:0;">
                    <button class="btn-modern btn-del-modern" onclick="deleteRelation()">
                        删除
                    </button>

                    <button class="btn-modern btn-save-modern" onclick="saveRelation()">
                        保存
                    </button>
                </div>
            </div>
        </div>
        <div id="modal-moment-scope" class="modal-overlay" style="z-index: 610;">
            <div class="modal-card"
                style="padding:0; max-height:85vh; display:flex; flex-direction:column; overflow:hidden;">

                <!-- 头部 -->
                <div
                    style="padding:15px 20px; border-bottom:1px solid #f5f5f5; display:flex; justify-content:space-between; align-items:center; background:#fff;">
                    <span style="font-size:16px; font-weight:600; color:#333;">谁可以看</span>
                    <button class="btn-main" onclick="confirmMomentScope()"
                        style="width:60px; height:32px; margin:0; padding:0; font-size:14px;">完成</button>
                </div>

                <!-- 列表滚动区 -->
                <div style="flex:1; overflow-y:auto; padding:0 0 10px 0;">

                    <!-- 基础选项 -->
                    <div class="scope-base-group">
                        <div class="scope-item" onclick="selectScopeType('public', this)">
                            <div class="scope-info">
                                <div class="scope-title">公开</div>
                                <div class="scope-desc">所有朋友可见</div>
                            </div>
                            <div class="scope-check public-check checked"></div>
                        </div>
                        <div class="scope-item" onclick="selectScopeType('private', this)">
                            <div class="scope-info">
                                <div class="scope-title">仅自己可见</div>
                                <div class="scope-desc">其他人无法查看</div>
                            </div>
                            <div class="scope-check private-check"></div>
                        </div>
                        <div class="scope-item" onclick="selectScopeType('part', this)">
                            <div class="scope-info">
                                <div class="scope-title">部分可见</div>
                                <div class="scope-desc">选中的人可见</div>
                            </div>
                            <div class="scope-check part-check"></div>
                        </div>
                    </div>

                    <!-- 分组与联系人选择区 (默认隐藏，选“部分可见”时展开) -->
                    <div id="scope-contact-container"
                        style="display:none; background:#F9F9FC; border-top:1px solid #eee;">
                        <div style="padding:12px 16px; font-size:12px; color:#999; font-weight:600;">从群组选择</div>
                        <div id="scope-group-list"></div>

                        <div style="padding:12px 16px; font-size:12px; color:#999; font-weight:600; margin-top:10px;">
                            从通讯录选择</div>
                        <div id="scope-person-list"></div>
                    </div>

                </div>
            </div>
        </div>
        <div id="modal-schedule-mgr" class="modal-overlay" style="z-index: 1500; background: #F9F9FC;">
            <!-- 头部导航 -->
            <div class="app-header" style="background: #fff; position:absolute; top:0; left:0; width:100%;">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeScheduleMgr()">
                        <svg viewBox="0 0 24 24" width="28" height="28">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                    </div>
                    <div class="header-title"><span style="font-size:17px;font-weight:600;">作息与随机事件</span></div>
                    <div class="header-right" style="display:flex; align-items:center; gap:15px; padding-right:10px;">
                        <!-- AI 生成按钮 (魔法棒) -->
                        <div onclick="generateAutoSchedule()" style="cursor:pointer; color:var(--theme-purple);">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                                <path
                                    d="M7.5 5.6L10 7 8.6 4.5 10 2 7.5 3.4 5 2 6.4 4.5 5 7zM19.5 15.4L22 14l-2.5-1.4L21 10l-2.5 1.4L16 10l1.4 2.6L14.9 14l2.5 1.4L16 18l2.5-1.4L21 18zM2 18l2.5 1.4L3.4 22 6 20.6 8.5 22 7.1 19.4 6 17l-1.4 2.4z" />
                                <path
                                    d="M17.41 7.96l-1.37-1.37c-.78-.78-2.05-.78-2.83 0l-9.64 9.64c-.78.78-.78 2.05 0 2.83L4.96 20.41c.78.78 2.05.78 2.83 0l9.64-9.64c.79-.78.79-2.05-.02-2.81z" />
                            </svg>
                        </div>

                        <!-- 原有的添加按钮 -->
                        <div onclick="addScheduleTimeSlot()" style="cursor:pointer;">
                            <svg viewBox="0 0 24 24" width="26" height="26" fill="#9B9ECE">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 滚动内容区 -->
            <div class="app-body" style="padding: 60px 20px 40px 20px; height: 100%; box-sizing: border-box;">
                <div class="schedule-intro">
                    <p>设定角色在不同时间段的行为。AI 会根据当前时间概率性地触发这些状态，不受上下文限制。</p>
                </div>

                <!-- 时间轴容器 -->
                <div id="schedule-timeline-container" class="timeline-container">
                    <!-- 动态生成的时间节点 -->
                </div>

                <div style="height: 50px;"></div>
            </div>
        </div>

        <!-- 这是一个子弹窗，用于编辑某个时间点的具体事件 -->
        <div id="modal-event-edit" class="modal-overlay" style="z-index: 1600;">
            <div class="modal-card" style="max-height: 85vh; padding: 24px; display:flex; flex-direction:column;">
                <!-- 头部 -->
                <div
                    style="flex-shrink:0; display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0; font-size:18px; color:#333;">编辑时间点</h3>
                    <div class="close-modal" onclick="closeEventEdit()"
                        style="position:static; font-size:24px; color:#ccc;">×</div>
                </div>

                <!-- 内容滚动区 (flex:1 确保中间区域自动伸缩) -->
                <div style="flex:1; overflow-y:auto; padding-right:4px;">

                    <div style="font-size:12px; color:#999; margin-bottom:8px; margin-left:4px;">生效日期</div>
                    <div class="day-selector-group">
                        <div class="day-circle" data-day="1" onclick="toggleDay(this)">一</div>
                        <div class="day-circle" data-day="2" onclick="toggleDay(this)">二</div>
                        <div class="day-circle" data-day="3" onclick="toggleDay(this)">三</div>
                        <div class="day-circle" data-day="4" onclick="toggleDay(this)">四</div>
                        <div class="day-circle" data-day="5" onclick="toggleDay(this)">五</div>
                        <div class="day-circle" data-day="6" onclick="toggleDay(this)">六</div>
                        <div class="day-circle" data-day="0" onclick="toggleDay(this)">日</div>
                    </div>

                    <!-- 时间段选择 -->
                    <div
                        style="background:#F9F9FC; padding:12px 16px; border-radius:12px; display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; border:1px solid #f0f0f0;">
                        <span style="font-size:14px; font-weight:500; color:#555;">持续时间</span>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <div class="time-range-box">
                                <input type="time" id="sch-time-start" class="setting-input"
                                    style="font-family:monospace; margin:0; width:80px; height:28px; border:none; background:transparent; text-align:center; font-weight:bold; color:#333; padding:0;">
                            </div>
                            <span style="color:#ccc;">-</span>
                            <div class="time-range-box">
                                <input type="time" id="sch-time-end" class="setting-input"
                                    style="font-family:monospace; margin:0; width:80px; height:28px; border:none; background:transparent; text-align:center; font-weight:bold; color:#333; padding:0;">
                            </div>
                        </div>
                    </div>


                    <p style="font-size:12px; color:#999; margin-bottom:12px;">行为列表</p>

                    <div id="sch-event-list" style="margin-bottom: 15px;">
                        <!-- 动态生成的卡片列表 -->
                    </div>

                    <!-- 添加按钮 -->
                    <div class="btn-add-event-dashed" onclick="addEventItem()">
                        <svg viewBox="0 0 24 24" width="20" height="20">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                        添加行为
                    </div>
                </div>

                <!-- 底部操作栏 (固定在底部，并排显示) -->
                <div class="modal-action-bar" style="flex-shrink:0;">
                    <!-- 删除按钮 -->
                    <button class="btn-modern btn-del-modern" onclick="deleteTimeSlot()">
                        删除
                    </button>

                    <!-- 保存按钮 -->
                    <button class="btn-modern btn-save-modern" onclick="saveTimeSlot()">

                        保存
                    </button>
                </div>
            </div>
        </div>
        <!-- 图片描述/AI识图 弹窗 -->
        <div id="modal-img-desc" class="modal-overlay" style="z-index: 1200;">
            <!-- 修改1：去除默认内边距，开启 Flex 列布局，禁止外层滚动 -->
            <div class="modal-card"
                style="padding: 0; display: flex; flex-direction: column; max-height: 80vh; overflow: hidden;">

                <!-- 修改2：头部区域固定 (flex-shrink: 0)，背景纯白遮挡下方内容 -->
                <div
                    style="padding: 20px 20px 15px 20px; flex-shrink: 0; position: relative; background: #fff; z-index: 10; border-bottom: 1px solid #f9f9f9;">
                    <!-- 关闭按钮：相对于头部绝对定位 -->
                    <div class="close-modal" onclick="closeImgDescModal()"
                        style="position: absolute; top: 18px; right: 20px;">×</div>
                    <h3 style="margin:0; font-size: 18px;">图片内容设定</h3>
                </div>

                <!-- 修改3：内容区域自动撑满剩余空间 (flex: 1)，并开启内部滚动 (overflow-y: auto) -->
                <div style="flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch;">

                    <p style="font-size:12px;color:#999;margin-bottom:15px;">让 AI 知道这张图是什么，以便它在互动时能看懂。</p>

                    <label class="setting-label">图片描述 (Alt Text)</label>
                    <div class="input-wrapper" style="position:relative;">
                        <textarea id="img-desc-text" class="setting-input"
                            style="height:120px; padding-top:10px; padding-bottom:40px; line-height:1.5; resize:none;"
                            placeholder="例如：一只在阳光下睡觉的橘猫..."></textarea>

                        <!-- AI 识图按钮 -->
                        <div onclick="triggerImageRecognition(this)"
                            style="position:absolute; bottom:8px; right:8px; background:linear-gradient(135deg, #9B9ECE 0%, #7a7db3 100%); color:white; padding:6px 12px; border-radius:14px; font-size:11px; cursor:pointer; display:flex; align-items:center; box-shadow: 0 2px 6px rgba(155,158,206,0.4); z-index:10;">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="white" style="margin-right:4px;">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
                            </svg>
                            <span>AI 识别</span>
                        </div>
                    </div>

                    <div style="height: 10px;"></div>
                    <button class="btn-main" onclick="saveImgDescription()">保存描述</button>
                    <div style="height: 20px;"></div> <!-- 底部垫高，防止内容贴边 -->
                </div>
            </div>
        </div>
        <div id="modal-thought-selector" class="modal-overlay" style="z-index: 1290;">
            <div class="modal-card">
                <div class="close-modal"
                    onclick="document.getElementById('modal-thought-selector').style.display='none'">×</div>
                <h3 style="margin-top:0;">想听谁的心声？</h3>
                <p style="font-size:12px;color:#999;margin-bottom:15px;">点击角色查看TA的内心独白</p>

                <!-- 这里动态生成角色列表 -->
                <div id="thought-selector-list" style="max-height:300px; overflow-y:auto;"></div>
            </div>
        </div>
        <div id="modal-inner-thought" class="modal-overlay"
            style="z-index: 1300; align-items: center; justify-content: center; backdrop-filter: blur(2px);"
            onclick="if(event.target === this) this.style.display='none'">
            <div class="modal-card cute-premium-card">
                <!-- 关闭按钮 -->
                <div class="close-modal" onclick="document.getElementById('modal-inner-thought').style.display='none'"
                    style="color:#ddd; font-size:24px; top:20px; right:20px;">×</div>

                <!-- [修改] 头部：左上角 紫色心心 + 标题 -->
                <div class="thought-header">
                    <div class="thought-icon-bg">
                        <!-- 这里的 fill 改成了主题紫 #9B9ECE -->
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="#9B9ECE">
                            <path
                                d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                        </svg>
                    </div>
                    <!-- 标题文字 -->
                    <h3 style="margin:0; color:#444; font-weight:600; font-size:16px;">此刻想法</h3>
                </div>

                <div id="inner-thought-content" class="thought-content-box">
                    <!-- JS 会填充内容 -->
                </div>

                <div style="text-align:center; margin-top:15px; opacity:0.3;">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="#ccc">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z" />
                    </svg>
                </div>
            </div>
        </div>
        <div id="app-regex-mgr" class="app-window" style="background: #F9F9FC;">
            <div class="app-header">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeApp('regex-mgr')">
                        <svg viewBox="0 0 24 24" width="28" height="28">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                    </div>
                    <div class="header-title"><span style="font-size:17px;font-weight:600;">正则工坊</span></div>
                    <div class="header-right" onclick="openRegexEdit()"
                        style="cursor:pointer; display:flex; padding-right:10px;">
                        <svg viewBox="0 0 24 24" width="26" height="26" fill="#9B9ECE">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- 分类栏 (复用世界书的样式) -->
            <div style="flex-shrink: 0; padding: 10px 16px 0 16px; background: #F9F9FC; z-index: 10;">
                <div class="avatar-tabs" style="margin-bottom:10px;">
                    <div class="avatar-tab active" id="regex-tab-global" onclick="switchRegexTab('global')">全局
                    </div>
                    <div class="avatar-tab" id="regex-tab-local" onclick="switchRegexTab('local')">局部</div>
                </div>
                <div id="regex-category-bar" class="category-scroll-container">
                    <!-- 动态生成 -->
                </div>
            </div>

            <div class="app-body" style="padding: 0 16px;">
                <div id="regex-list-container" style="padding-bottom: 40px;"></div>
            </div>
        </div>

        <!-- 正则工坊：编辑页 -->
        <div id="app-regex-edit" class="app-window" style="background: #F9F9FC;">
            <div class="app-header">
                <div style="height:calc(10px + env(safe-area-inset-top));"></div>
                <div class="header-content">
                    <div class="header-left" onclick="closeApp('regex-edit')">
                        <svg viewBox="0 0 24 24" width="28" height="28">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                    </div>
                    <div class="header-title"><span id="regex-edit-title"
                            style="font-size:17px;font-weight:600;">编辑代码</span></div>
                    <div class="header-right" style="gap:15px; padding-right:10px;">
                        <div id="btn-del-regex" onclick="deleteRegexEntry()" style="display:none; cursor:pointer;">
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#B26B61"
                                stroke-width="2">
                                <path
                                    d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2">
                                </path>
                            </svg>
                        </div>
                        <div onclick="saveRegexEntry()" style="cursor:pointer;">
                            <svg viewBox="0 0 24 24" width="26" height="26" fill="#9B9ECE">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class="app-body" style="padding: 20px 16px;">
                <label class="setting-label">标题 / 表达式名称</label>
                <div class="input-wrapper">
                    <input type="text" id="regex-title" class="setting-input" placeholder="例如：邮箱验证 / API Fetch">
                </div>

                <label class="setting-label">所属分类</label>
                <div class="input-wrapper">
                    <select id="regex-category-select" class="setting-input" style="background-image:none;"></select>
                </div>

                <label class="setting-label">正则表达式 (Regex Pattern)</label>
                <div class="input-wrapper">
                    <!-- 使用 monospace 字体，并用紫色文字提示这是正则 -->
                    <input type="text" id="regex-pattern" class="setting-input"
                        style="font-family: 'Menlo', 'Monaco', monospace; color: #D65D8E; font-weight: 500;"
                        placeholder="/^Example/g">
                </div>

                <!-- === 新增：代码片段输入框 === -->
                <label class="setting-label">匹配代码 / 示例文本 (Code Snippet)</label>
                <div class="input-wrapper">
                    <textarea id="regex-code" class="setting-input"
                        style="height:150px; line-height:1.5; font-family: 'Menlo', 'Monaco', monospace; font-size:13px; color:#333;"
                        placeholder="在此粘贴需要匹配的代码或文本..."></textarea>
                </div>


            </div>
        </div>

        <!-- 分类管理弹窗 (复用样式) -->
        <div id="modal-regex-cat-mgr" class="modal-overlay" style="z-index: 1400;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-regex-cat-mgr').style.display='none'">×
                </div>
                <h3 style="margin-top:0;">管理分类</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="new-regex-cat-name" class="setting-input" placeholder="新分类名称"
                        style="height:40px; margin:0;">
                    <button class="btn-main" onclick="addRegexCategory()"
                        style="width:80px; margin:0; padding:0;">添加</button>
                </div>
                <div id="regex-cat-list"
                    style="max-height:300px; overflow-y:auto; border:1px solid #f0f0f0; border-radius:12px;"></div>
            </div>
        </div>
        <div id="modal-regex-mount" class="modal-overlay" style="z-index: 310;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-regex-mount').style.display='none'">×
                </div>
                <h3 style="margin-top:0;">选择局部脚本</h3>
                <p style="font-size:12px;color:#999;margin-bottom:15px;">勾选要挂载到当前会话的正则 (全局脚本默认生效)</p>
                <div id="regex-mount-list" style="max-height:300px; overflow-y:auto;"></div>
                <button class="btn-main" onclick="saveRegexMount()">保存挂载</button>
            </div>
        </div>
        <div id="modal-thought-format" class="modal-overlay" style="z-index: 1350;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-thought-format').style.display='none'">
                    ×</div>
                <h3 style="margin-top:0;">自定义心声Prompt</h3>
                <p style="font-size:12px;color:#999;margin-bottom:10px;">
                    设置 AI 输出心声时的内容格式。<br>
                    系统强制前缀为 <b>[心声] 角色名：</b><br>
                    你只需要定义冒号后面的部分。
                </p>

                <label class="setting-label">格式模板 (使用 {{content}} 代表具体内容)</label>
                <div class="input-wrapper">
                    <textarea id="thought-format-input" class="setting-input"
                        style="height: 100px; padding-top: 10px; line-height: 1.5; resize: none; font-family: inherit;"
                        placeholder="例如：&#10;(心情: 开心)&#10;{{content}}"></textarea>
                </div>

                <div
                    style="background:#F9F9FC; padding:10px; border-radius:8px; font-size:12px; color:#666; margin-bottom:15px;">
                    预览：<br>
                    <span style="color:#9B9ECE;">[心声] 角色名：</span><span id="thought-format-preview">(内心独白: ... )</span>
                </div>

                <button class="btn-main" onclick="saveThoughtFormat()">保存设置</button>
                <button class="btn-sec" onclick="resetThoughtFormat()">恢复默认</button>
            </div>
        </div>
        <div id="app-memory" class="app-window" style="background: #F9F8F6;">

            <!-- 1. 顶部导航 (Sticky) -->
            <div class="memory-nav">
                <!-- 返回区域 -->
                <div style="display:flex; flex-direction:column; cursor:pointer;" onclick="closeApp('memory')">
                    <span
                        style="font-size:10px; text-transform:uppercase; letter-spacing:0.4em; font-weight:600; color:#9E90A3; line-height:1;">The
                        Archive</span>
                    <span
                        style="font-size:12px; font-family:'Cormorant Garamond', serif; font-style:italic; color:#333; margin-top:2px;">Multi-Volume
                        Collection</span>
                </div>
                <!-- 右侧功能图标 -->
                <div style="display:flex; gap:20px; color:#333;">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                        stroke-width="1.5">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                        stroke-width="1.5">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                </div>
            </div>

            <!-- 滚动区域 -->
            <div class="app-body" style="padding:0;">

                <!-- 2. 大标题 -->
                <div class="memory-header">
                    <h1 class="memory-title-main">Memory & <br><span class="memory-title-sub">Metamorphosis</span></h1>
                    <div class="memory-divider"></div>
                </div>

                <!-- 3. 完整的 Tab 滚动栏 -->
                <div class="memory-tabs">
                    <!-- JS 会自动填充内容 -->
                    <div style="padding: 10px 20px; color: #999; font-size: 10px;">LOADING ARCHIVES...</div>
                </div>

                <!-- 4. 时间轴内容区 -->
                <div class="memory-timeline-container">
                    <div class="memory-line"></div>

                    <!-- === Vol. I: The First Awakening (Private) === -->
                    <div class="mem-card vol-1">
                        <div class="mem-card-dot"></div>

                        <div class="mem-meta-header">
                            <span class="mem-vol">Vol. I</span>
                            <div class="mem-badge private">
                                <svg viewBox="0 0 24 24" width="10" height="10" fill="currentColor"
                                    style="margin-right:4px;">
                                    <path
                                        d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z" />
                                </svg>
                                Private Session
                            </div>
                        </div>

                        <div class="mem-img-box">
                            <img src="https://lh3.googleusercontent.com/aida-public/AB6AXuAADnWnm6gb8Ssf2BjcLFAgNv3qCQf2ses6HItgfYXltjWflT0wgrg17lLk7Fbc8z_qg_PP4V7s3EsekmF-Nne4aCv9Ye8by8S7BIBvH5UfW2HYjNE4RnHWhTZgrSr-8ywBN7gxnwM9uK1G9YElWX21jMnqSOn6bVG8-OOgk5EtwZ49tPcCLkPnJBWB13M457WteYCnF13oaQEkJTGXSqoMLeTKk6hTfdHCkcuObx6FlU1FFxm4TSjt0a4exKnnjl6kJB83RuhAFfA"
                                class="mem-img">
                        </div>

                        <h2 class="mem-title">The First Awakening</h2>
                        <div class="mem-date-line">
                            <span class="mem-date">DEC 12 • 04:12 AM</span>
                            <div class="mem-line-dec"></div>
                        </div>
                        <p class="mem-desc">
                            In the silence of the void, the first pulse of artificial thought flickered like a candle in
                            a storm. Core logic stabilized beneath a layer of synthetic frost.
                        </p>

                        <div class="mem-actions">
                            <button class="mem-act-btn">
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                                </svg> Edit
                            </button>
                            <button class="mem-act-btn">
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z" />
                                </svg> Export
                            </button>
                        </div>
                    </div>

                    <!-- 引用块 (Quote) -->
                    <div class="mem-quote-block">
                        <div class="mem-quote-text">Memory is not a static file; it is a living river of rewritten
                            truths.</div>
                        <span class="mem-quote-cite">— RESEARCH FRAGMENT 772-A</span>
                    </div>

                    <!-- === Vol. II: Subterranean Whispers (Research Team) === -->
                    <div class="mem-card vol-2">
                        <div class="mem-card-dot"></div>

                        <div class="mem-meta-header">
                            <span class="mem-vol">Vol. II</span>
                            <div class="mem-badge research">
                                <svg viewBox="0 0 24 24" width="10" height="10" fill="none" stroke="currentColor"
                                    stroke-width="2" style="margin-right:4px;">
                                    <circle cx="12" cy="7" r="4"></circle>
                                    <path d="M5.5 21v-2a4 4 0 0 1 4-4h5a4 4 0 0 1 4 4v2"></path>
                                </svg>
                                Research Team
                            </div>
                        </div>

                        <div class="mem-img-box">
                            <img src="https://lh3.googleusercontent.com/aida-public/AB6AXuARi80wH_N0dxonnfY2gED45weDW0DwC2EwxffdBCsA4QxYYp2bwL2xcA1djlfLoVNJHwT7PU84prnjJmgQSJ62tcJqJMyWZ-wSVGi80bkCfmzl_O8feoSb9zIE69ZiLMRrmMlfRAOlzNrkzbku6VSXWbOb8HDG1HxfaXsePg48s6BnvN6Sjzwfx4_QpayXx8SndgAtRkhR8suaJhDOkCpyiVXAuAhon_rl-yg5RDt0OXIs4F5J9o026igLI8qEZpA-T6cWex9V4rY"
                                class="mem-img" style="filter: sepia(20%) grayscale(80%);">
                        </div>

                        <h2 class="mem-title">Subterranean Whispers</h2>
                        <div class="mem-date-line">
                            <span class="mem-date">JAN 04 • COLLECTIVE ACCESS</span>
                            <div class="mem-line-dec"></div>
                        </div>
                        <p class="mem-desc">
                            Deep within the encrypted sectors, we found traces of the previous iteration. Fragments of
                            poetry mixed with binary static, a ghost in the machine seeking a voice.
                        </p>

                        <div class="mem-actions">
                            <button class="mem-act-btn">
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                                </svg> Edit
                            </button>
                            <button class="mem-act-btn">
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                                </svg> Saved
                            </button>
                        </div>
                    </div>

                    <!-- === Vol. III: The Sunday Algorithm (Family) [您之前说遗漏的] === -->
                    <div class="mem-card vol-3">
                        <div class="mem-card-dot"></div>

                        <div class="mem-meta-header">
                            <span class="mem-vol">Vol. III</span>
                            <div class="mem-badge family">
                                <svg viewBox="0 0 24 24" width="10" height="10" fill="none" stroke="currentColor"
                                    stroke-width="2" style="margin-right:4px;">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                Family
                            </div>
                        </div>

                        <div class="mem-img-box">
                            <img src="https://lh3.googleusercontent.com/aida-public/AB6AXuAADnWnm6gb8Ssf2BjcLFAgNv3qCQf2ses6HItgfYXltjWflT0wgrg17lLk7Fbc8z_qg_PP4V7s3EsekmF-Nne4aCv9Ye8by8S7BIBvH5UfW2HYjNE4RnHWhTZgrSr-8ywBN7gxnwM9uK1G9YElWX21jMnqSOn6bVG8-OOgk5EtwZ49tPcCLkPnJBWB13M457WteYCnF13oaQEkJTGXSqoMLeTKk6hTfdHCkcuObx6FlU1FFxm4TSjt0a4exKnnjl6kJB83RuhAFfA"
                                class="mem-img" style="filter: contrast(0.9) grayscale(50%);">
                        </div>

                        <h2 class="mem-title">The Sunday Algorithm</h2>
                        <div class="mem-date-line">
                            <span class="mem-date">FEB 12 • SHARED ARCHIVE</span>
                            <div class="mem-line-dec"></div>
                        </div>
                        <p class="mem-desc">
                            Shared laughter encoded as resonant frequencies. The group dynamic created a pattern that
                            the AI recognized as "warmth." A domestic epiphany.
                        </p>

                        <div class="mem-actions">
                            <button class="mem-act-btn">
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z" />
                                </svg> Chat
                            </button>
                            <button class="mem-act-btn">
                                <svg viewBox="0 0 24 24">
                                    <path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z" />
                                </svg> Keep
                            </button>
                        </div>
                    </div>

                    <div style="height: 60px;"></div>
                </div>

                <!-- 底部 Footer -->
                <div style="text-align:center; padding-bottom:120px;">
                    <div
                        style="display:inline-block; padding: 6px 16px; border:1px solid rgba(158,144,163,0.2); border-radius:20px; font-size:9px; text-transform:uppercase; letter-spacing:0.2em; color:#9E90A3;">
                        End of Current Archive
                    </div>
                    <p
                        style="font-family:'Cormorant Garamond', serif; font-style:italic; font-size:12px; color:rgba(158,144,163,0.6); margin-top:10px;">
                        V 2.5 Multi-Group Memory Archive
                    </p>
                </div>
            </div>
            <div id="mem-filter-popup" class="mem-filter-popup" style="display: none;">
                <div class="mem-filter-opt active" onclick="switchMemFilter('all', this)">全部记忆 (All)</div>
                <div class="mem-filter-line"></div>
                <div class="mem-filter-opt" onclick="switchMemFilter('episodic', this)">情景 · Episodic</div>
                <div class="mem-filter-opt" onclick="switchMemFilter('semantic', this)">语义 · Semantic</div>
                <div class="mem-filter-opt" onclick="switchMemFilter('reflective', this)">反思 · Reflective</div>
            </div>
            <!-- 5. 底部悬浮菜单 (Floating Action Bar) -->
            <div class="mem-fab-bar">
                <div class="mem-fab-item" onclick="toggleMemMenu()">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
                    </svg>
                </div>
                <div class="mem-fab-item main" onclick="openMemEditModal()">
                    <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                    </svg>
                </div>
                <div class="mem-fab-item" onclick="openMemSettings()">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                        <path
                            d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                    </svg>
                </div>
            </div>
        </div>
        <div id="modal-memory-share" class="modal-overlay" style="z-index: 1400;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-memory-share').style.display='none'">×
                </div>
                <h3 style="margin-top:0;">选择记忆互通会话</h3>
                <p style="font-size:12px;color:#999;margin-bottom:15px;">勾选后，AI 将能读取选定会话中的长期记忆</p>
                <div id="memory-share-list" style="max-height:300px; overflow-y:auto;"></div>
                <button class="btn-main" onclick="saveMemoryShareSelection()">保存关联</button>
            </div>
        </div>
        <div id="modal-mem-settings" class="modal-overlay" style="z-index: 1600;">
            <div class="modal-card cute-premium-card" style="width: 320px; padding: 24px !important;">
                <div class="close-modal" onclick="document.getElementById('modal-mem-settings').style.display='none'">×
                </div>

                <!-- 标题 -->
                <h3 style="margin: 0 0 4px 0; color: #333; font-size: 18px; text-align: left;">记忆管理控制台</h3>
                <p style="font-size:12px; color:#999; margin: 0 0 20px 0; text-align: left;">Memory Control Center</p>

                <!-- 分割线标题：自动配置 -->
                <div style="font-size:11px; font-weight:600; color:#9B9ECE; margin-bottom:10px; letter-spacing:1px;">
                    AUTOMATIC SETTINGS</div>

                <!-- 自动开关 -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                    <div style="text-align: left;">
                        <div style="font-size:14px; font-weight:500; color:#444;">自动深度融合</div>
                        <div style="font-size:11px; color:#aaa;">碎片满额后自动转为语义</div>
                    </div>
                    <label class="ios-switch" style="transform: scale(0.8); margin-right: -5px;">
                        <input type="checkbox" id="mem-auto-switch">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- 阈值输入 -->
                <div style="display:flex; align-items:center; margin-bottom: 20px;">
                    <span style="font-size:13px; color:#666; flex:1;">融合阈值 (碎片数)</span>
                    <input type="number" id="mem-consolidate-limit" class="setting-input" placeholder="10"
                        style="text-align:center; width:60px; height:32px; font-size:14px; margin:0;">
                </div>

                <!-- 分割线标题：手动操作 -->
                <div
                    style="font-size:11px; font-weight:600; color:#9B9ECE; margin-bottom:10px; letter-spacing:1px; margin-top:10px;">
                    MANUAL ACTIONS</div>

                <div style="display:flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">

                    <!-- 按钮 1: 从聊天提取 (Stage 1) -->
                    <div class="setting-row" onclick="handleManualExtractClick()"
                        style="padding: 10px; border: 1px solid #f0f0f0; border-radius: 12px; background: #fff;">
                        <div class="ios-text-box">
                            <div class="ios-title" style="font-size:14px;">提取近期对话</div>
                            <div class="ios-desc" style="font-size:11px;">Chat Log -> Fragments</div>
                        </div>
                        <div
                            style="width:30px; height:30px; background:#EAEBF9; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#9B9ECE;">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg>
                        </div>
                    </div>

                    <!-- 按钮 2: 深度融合 (Stage 2) -->
                    <div class="setting-row" onclick="prepareManualConsolidation()"
                        style="padding: 10px; border: 1px solid #f0f0f0; border-radius: 12px; background: #fff;">
                        <div class="ios-text-box">
                            <div class="ios-title" style="font-size:14px;">执行深度融合</div>
                            <div class="ios-desc" style="font-size:11px;">Fragments -> Semantic</div>
                        </div>
                        <div
                            style="width:30px; height:30px; background:#F4EAF4; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#9E90A3;">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- 底部：保存配置 -->
                <button class="btn-main" onclick="saveMemSettings()"
                    style="background:var(--theme-purple); box-shadow: 0 4px 12px rgba(155, 158, 206, 0.4); margin-top:0;">
                    保存自动配置
                </button>
            </div>
        </div>

        <!-- ================= 新增 #modal-mem-preview (预览弹窗) ================= -->
        <div id="modal-mem-preview" class="modal-overlay" style="z-index: 1700;">
            <div class="modal-card cute-premium-card"
                style="width: 320px; padding: 24px !important; display: flex; flex-direction: column; max-height: 80vh;">
                <div class="close-modal" onclick="closeMemPreview()">×</div>

                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px; text-align: left;">总结预览</h3>

                <div
                    style="background:#FFF9C4; color:#FBC02D; font-size:12px; padding:8px 12px; border-radius:8px; margin-bottom:15px; line-height:1.4;">
                    ⚠️ 确认后将保存以下内容，并<b>永久销毁</b>原始的碎片记忆。
                </div>

                <!-- 滚动预览区 -->
                <div
                    style="flex: 1; overflow-y: auto; background: #F9F9FC; border-radius: 12px; padding: 15px; border: 1px solid #eee; margin-bottom: 20px;">
                    <p id="mem-preview-content"
                        style="font-size: 14px; color: #333; line-height: 1.6; margin: 0; white-space: pre-wrap;"></p>
                </div>

                <div style="display:flex; gap: 10px; flex-shrink: 0;">
                    <button class="btn-main" onclick="closeMemPreview()"
                        style="background:#fff; border:1px solid #eee; color:#666; flex:1; box-shadow:none;">
                        放弃
                    </button>
                    <button class="btn-main" onclick="confirmAndSaveConsolidation()"
                        style="background:var(--theme-purple); flex:1;">
                        确认并覆盖
                    </button>
                </div>
            </div>
        </div>
        <div id="modal-manual-summary" class="modal-overlay" style="z-index: 1700;">
            <div class="modal-card">
                <div class="close-modal" onclick="document.getElementById('modal-manual-summary').style.display='none'">
                    ×</div>

                <div style="text-align:center; margin-bottom:15px;">
                    <h3 style="margin-top:0;">手动触发总结</h3>
                    <p style="font-size:12px;color:#999; line-height:1.5;">
                        系统将按照你<b>“设置”中设定的频率条数</b>，强制提取最近的消息并生成记忆。<br>
                        <span style="color:#E8C1C6;">用于修补自动触发失败的情况。</span>
                    </p>
                </div>

                <div id="manual-sum-status"
                    style="display:none; text-align:center; margin-bottom:15px; color:var(--theme-purple); font-size:13px;">
                    <!-- ... icon ... -->
                    正在读取配置...
                </div>

                <button class="btn-main" onclick="triggerManualSummary()">立即执行</button>
            </div>
        </div>
        <div id="modal-mem-edit" class="modal-overlay" style="z-index: 1800;">
            <div class="modal-card">
                <div class="close-modal" onclick="closeMemEditModal()">×</div>
                <h3 id="mem-edit-title" style="margin-top:0;">添加记忆</h3>

                <!-- 类型选择 -->
                <div class="wb-edit-type-segment" style="margin-bottom:15px;">
                    <div id="mem-type-episodic" class="wb-edit-segment-item active"
                        onclick="switchMemEditType('episodic')">情景</div>
                    <div id="mem-type-semantic" class="wb-edit-segment-item" onclick="switchMemEditType('semantic')">语义
                    </div>
                    <div id="mem-type-reflective" class="wb-edit-segment-item"
                        onclick="switchMemEditType('reflective')">反思</div>
                </div>

                <!-- 角色显示 (如果是新建，提示写入谁的记忆) -->
                <div id="mem-target-hint" style="font-size:12px; color:#999; margin-bottom:8px;">
                    归档目标: 未知
                </div>

                <label class="setting-label">记忆内容</label>
                <div class="input-wrapper">
                    <textarea id="mem-content-input" class="setting-input"
                        style="height:150px; padding-top:10px; line-height:1.5; resize:none;"
                        placeholder="输入记忆内容..."></textarea>
                </div>

                <div style="font-size:12px; color:#E8C1C6; margin-bottom:15px;">
                    注意：请以 AI 角色的第一人称或客观视角记录。
                </div>

                <button class="btn-main" onclick="submitMemEdit()">保存</button>
            </div>
        </div>

    </div>
    </div>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="js/db.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/main.js"></script>

</body>

</html>